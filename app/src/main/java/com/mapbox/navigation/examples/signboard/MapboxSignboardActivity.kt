package com.mapbox.navigation.examples.signboard

import android.annotation.SuppressLint
import android.location.Location
import android.os.Bundle
import android.view.View
import androidx.appcompat.app.AppCompatActivity
import androidx.core.view.isVisible
import androidx.lifecycle.lifecycleScope
import com.mapbox.api.directions.v5.models.DirectionsRoute
import com.mapbox.bindgen.Expected
import com.mapbox.geojson.Point
import com.mapbox.maps.CameraOptions
import com.mapbox.maps.EdgeInsets
import com.mapbox.maps.MapboxMap
import com.mapbox.maps.Style
import com.mapbox.maps.plugin.animation.MapAnimationOptions
import com.mapbox.maps.plugin.animation.camera
import com.mapbox.maps.plugin.locationcomponent.LocationComponentPlugin
import com.mapbox.maps.plugin.locationcomponent.location
import com.mapbox.navigation.base.options.NavigationOptions
import com.mapbox.navigation.base.route.NavigationRoute
import com.mapbox.navigation.base.route.RouterOrigin
import com.mapbox.navigation.base.route.toNavigationRoute
import com.mapbox.navigation.core.MapboxNavigation
import com.mapbox.navigation.core.MapboxNavigationProvider
import com.mapbox.navigation.core.directions.session.RoutesObserver
import com.mapbox.navigation.core.replay.MapboxReplayer
import com.mapbox.navigation.core.replay.ReplayLocationEngine
import com.mapbox.navigation.core.replay.route.ReplayProgressObserver
import com.mapbox.navigation.core.replay.route.ReplayRouteMapper
import com.mapbox.navigation.core.trip.session.BannerInstructionsObserver
import com.mapbox.navigation.core.trip.session.LocationMatcherResult
import com.mapbox.navigation.core.trip.session.LocationObserver
import com.mapbox.navigation.examples.R
import com.mapbox.navigation.examples.databinding.MapboxActivitySignboardBinding
import com.mapbox.navigation.ui.base.util.MapboxNavigationConsumer
import com.mapbox.navigation.ui.maps.guidance.signboard.api.MapboxSignboardApi
import com.mapbox.navigation.ui.maps.guidance.signboard.model.SignboardError
import com.mapbox.navigation.ui.maps.guidance.signboard.model.SignboardValue
import com.mapbox.navigation.ui.maps.guidance.signboard.view.MapboxSignboardView
import com.mapbox.navigation.ui.maps.location.NavigationLocationProvider
import com.mapbox.navigation.ui.maps.route.line.MapboxRouteLineApiExtensions.setNavigationRoutes
import com.mapbox.navigation.ui.maps.route.line.api.MapboxRouteLineApi
import com.mapbox.navigation.ui.maps.route.line.api.MapboxRouteLineView
import com.mapbox.navigation.ui.maps.route.line.model.MapboxRouteLineOptions
import com.mapbox.navigation.ui.maps.route.line.model.RouteLineResources
import kotlinx.coroutines.launch

/**
 * This activity demonstrates the usage of the [MapboxSignboardApi]. There is boiler plate
 * code for establishing basic navigation and a route simulator is used. The example assumes
 * that LOCATION permission has already been granted.
 *
 * The code specifically related to the signboard component is commented in order to call
 * attention to its usage. The example uses a predefined location pair to demonstrate signboard.
 * Click "Set Route" button to use predefined coordinates and trigger navigation.
 *
 * Note: A special access token is required to get access to signboards in directions response.
 */
class MapboxSignboardActivity : AppCompatActivity() {

    private val route = DirectionsRoute
        .fromJson("""{"routeIndex":0,"country_crossed":false,"weight_typical":273.186,"duration_typical":238.683,"weight_name":"auto","weight":267.765,"duration":238.591,"distance":5828.338,"legs":[{"via_waypoints":[],"admins":[{"iso_3166_1_alpha3":"ESP","iso_3166_1":"ES"}],"annotation":{"maxspeed":[{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true}],"congestion_numeric":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,12,12,12,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,12,12,12,12,12,12,12,null,1,1,1,12,12,12,12,12,12,0,0,0,0,0,0,0,12,12,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,null,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"speed":[30.6,30.6,30.6,30.6,30.6,30.6,30.6,30.6,30.6,30.6,30.6,30.6,30.6,30.6,30.6,30.6,19.4,19.4,19.4,19.4,20.8,20.8,20.8,20.8,20.8,20.8,20.8,20.8,20.8,20.8,20.8,20.8,20.8,20.8,20.8,20.8,20.8,20.8,20.8,20.8,20.8,21.1,21.1,21.1,21.1,11.1,11.1,11.1,11.1,11.1,11.1,11.1,11.1,8.9,8.9,8.9,9.2,9.2,9.2,9.2,9.2,10.6,10.6,10.6,9.4,9.4,9.4,9.4,9.4,9.4,10,10,10,10,10,10,10,8.9,8.9,8.9,17.2,17.2,17.2,17.2,17.2,17.2,17.2,17.2,17.2,17.2,17.2,17.2,17.2,17.2,17.2,17.2,17.2,17.2,17.2,17.2,17.2,17.2,17.2,17.2,18.3,18.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,10.3,9.4,9.4,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.7,34.2,34.2,34.2,34.2,34.2,34.2,34.2,34.2,34.2,34.2,34.2,34.2,34.2,34.2,34.2,34.2,34.2,34.2,34.2,34.2,34.2,29.4,29.4],"distance":[33.7,86.6,62,9.3,18.3,35.3,19.2,36.3,21.6,22.7,13.6,30.5,16.9,36.1,24.7,52.9,33.3,19.4,23.8,21.4,19.2,19.2,20.5,10.6,3.4,11.9,12.6,11.6,13.5,16.8,21.5,20,17.7,15.6,15.1,17,19.1,19,15.6,12.4,1.1,51.5,80.5,24.6,16.8,19.1,12.4,14.7,11.9,9.3,8.1,8.1,8.8,6,7.5,5.4,6.1,4.2,5.1,2.5,3.3,6.7,5.6,5.6,8.2,6.5,8.1,6.1,7.5,6,8.5,9.6,6.8,8.1,7,7.1,6.9,5.6,6.7,6.7,12.4,13.4,13.6,15.9,12.5,12.4,13.5,35.8,21.2,125.2,16.8,15.8,12.5,14,14.6,14.4,14,12.9,10.1,9.4,8.8,19.9,7.1,8.7,9.6,11.9,15.9,9.6,9.9,12.9,9.5,9.3,9.9,10.2,10.1,12.7,10.2,10.3,9.4,11.9,9.6,8.5,8.7,9.9,11.5,10.9,10.2,10.3,12.4,11.1,10.1,12.4,11.3,13.6,15.7,8.5,7.4,31.6,28.3,36.1,33.8,43.9,39.4,40.6,41.7,36.1,27.2,29.4,27.2,20.3,25,41,35.3,27.4,24.1,33.4,40.5,39.4,39.4,37.3,25.6,19.8,23.5,25.9,31,40.5,51.4,39.8,55.1,62.5,46.9,70.1,74.7,57.3,34.9,35.3,40.9,26.5,46,45.6,50,20.6,21.2,35.5,48.1,34.5,28.4,19.6,25,81.1,32.5,108.9,197.5,100.1,186.6,23,31.8,100.7,63.6,19.6,25,100.1,77.1,58.4,29.3,26,17.9,33.2,30.8,32.2,17.7,36.3,27.4,29.4,29,18.7,17.3,29.2,35,36.8,25.9,24.6,27.7],"duration":[1.103,2.833,2.029,0.303,0.599,1.157,0.629,1.187,0.706,0.742,0.445,0.998,0.553,1.182,0.809,1.73,1.715,0.997,1.222,1.102,0.923,0.923,0.983,0.508,0.165,0.572,0.605,0.559,0.647,0.805,1.032,0.96,0.851,0.75,0.724,0.818,0.916,0.912,0.749,0.594,0.053,2.437,3.814,1.166,0.795,1.718,1.113,1.322,1.072,0.837,0.731,0.729,0.793,0.677,0.849,0.606,0.67,0.457,0.559,0.272,0.362,0.638,0.527,0.533,0.868,0.69,0.86,0.643,0.799,0.638,0.846,0.956,0.68,0.812,0.699,0.714,0.689,0.626,0.751,0.757,0.718,0.777,0.79,0.926,0.726,0.718,0.782,2.078,1.232,7.267,0.975,0.917,0.726,0.814,0.848,0.837,0.812,0.748,0.588,0.547,0.512,1.153,0.413,0.508,0.522,0.648,1.543,0.93,0.961,1.251,0.925,0.905,0.959,0.989,0.978,1.236,0.997,1.004,0.917,1.154,0.93,0.823,0.851,0.962,1.114,1.06,0.997,1.006,1.203,1.083,0.978,1.203,1.096,1.323,1.525,0.904,0.785,0.909,0.815,1.04,0.973,1.265,1.135,1.17,1.202,1.04,0.783,0.846,0.783,0.585,0.72,1.18,1.018,0.788,0.695,0.961,1.166,1.135,1.135,1.074,0.739,0.571,0.678,0.746,0.892,1.166,1.479,1.145,1.585,1.801,1.351,2.02,2.15,1.651,1.005,1.018,1.178,0.763,1.326,1.314,1.439,0.594,0.611,1.021,1.386,0.994,0.817,0.565,0.72,2.336,0.936,3.135,5.688,2.884,5.375,0.662,0.914,2.902,1.833,0.565,0.732,2.931,2.257,1.71,0.858,0.76,0.522,0.972,0.9,0.941,0.517,1.062,0.803,0.859,0.848,0.548,0.508,0.855,1.025,1.076,0.758,0.835,0.941]},"weight_typical":273.186,"duration_typical":238.683,"weight":267.765,"duration":238.591,"steps":[{"voiceInstructions":[{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Drive north on <phoneme alphabet='nt-sampa' ph='au|to|\"Bi|a \"a \"u|no'>A-1<\/phoneme>, <phoneme alphabet='nt-sampa' ph='\"e \"TiN|ko'>E-5<\/phoneme>. Then Take exit <say-as interpret-as=\"address\">23<\/say-as>.<\/prosody><\/amazon:effect><\/speak>","announcement":"Drive north on A-1, E-5. Then Take exit 23.","distanceAlongGeometry":520.045},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Take exit <say-as interpret-as=\"address\">23<\/say-as> toward <phoneme alphabet='nt-sampa' ph='\"e|me \"Tjen'>M-100<\/phoneme>, <phoneme alphabet='nt-sampa' ph='ko|\"Be|Ja'>Cobe\u00f1a<\/phoneme>.<\/prosody><\/amazon:effect><\/speak>","announcement":"Take exit 23 toward M-100, Cobe\u00f1a.","distanceAlongGeometry":226.667}],"intersections":[{"classes":["motorway"],"entry":[true],"bearings":[17],"duration":1.114,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":0,"weight":0.947,"geometry_index":0,"location":[-3.587044,40.57191]},{"entry":[true,false],"classes":["motorway"],"in":1,"bearings":[15,197],"duration":2.847,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":0,"weight":2.42,"geometry_index":1,"location":[-3.58693,40.5722]},{"entry":[true,false],"classes":["motorway"],"in":1,"bearings":[14,195],"duration":2.029,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":0,"weight":1.725,"geometry_index":2,"location":[-3.58666,40.57295]},{"entry":[true,false],"classes":["motorway"],"in":1,"bearings":[14,194],"duration":3.862,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":0,"weight":3.283,"geometry_index":3,"location":[-3.58648,40.57349]},{"entry":[true,false],"classes":["motorway"],"in":1,"bearings":[11,191],"duration":1.44,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":0,"weight":1.224,"geometry_index":8,"location":[-3.58619,40.57453]},{"lanes":[{"indications":["straight"],"valid":false,"active":false},{"indications":["straight"],"valid":false,"active":false},{"indications":["straight"],"valid":false,"active":false},{"indications":["straight","slight right"],"valid_indication":"slight right","valid":true,"active":true}],"bearings":[10,191],"entry":[true,false],"classes":["motorway"],"in":1,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":0,"geometry_index":10,"location":[-3.58609,40.57492]}],"bannerInstructions":[{"view":{"components":[{"imageURL":"https:\/\/api.mapbox.com\/guidance-views\/v1\/1652918400\/jct\/JV_11484622860?arrow_ids=JV_11484622862","subType":"jct","type":"guidance-view","text":""},{"imageURL":"https:\/\/api.mapbox.com\/guidance-views\/v1\/1652918400\/signboard\/SI_1241914001A2","subType":"signboard","type":"guidance-view","text":""}],"type":"off ramp","modifier":"right","text":""},"sub":{"components":[{"active":false,"directions":["straight"],"type":"lane","text":""},{"active":false,"directions":["straight"],"type":"lane","text":""},{"active":false,"directions":["straight"],"type":"lane","text":""},{"active_direction":"slight right","active":true,"directions":["straight","slight right"],"type":"lane","text":""}],"text":""},"primary":{"components":[{"type":"exit","text":"Exit"},{"type":"exit-number","text":"23"},{"mapbox_shield":{"text_color":"black","name":"default","display_ref":"M-100","base_url":"https:\/\/api.mapbox.com\/styles\/v1"},"type":"icon","text":"M-100"},{"type":"delimiter","text":"\/"},{"type":"text","text":"Cobe\u00f1a"}],"type":"off ramp","modifier":"right","text":"Exit 23 M-100 \/ Cobe\u00f1a"},"distanceAlongGeometry":520.045}],"speedLimitUnit":"km\/h","maneuver":{"type":"depart","instruction":"Drive north on A-1\/E-5\/Autov\u00eda del Norte.","bearing_after":17,"bearing_before":0,"location":[-3.587044,40.57191]},"speedLimitSign":"vienna","pronunciation":"au|to|\"Bi|a %del \"nor|te","name":"Autov\u00eda del Norte","weight_typical":13.261,"duration_typical":15.601,"duration":17.02,"distance":520.045,"driving_side":"right","weight":14.467,"mode":"driving","ref":"A-1; E-5","geometry":"k_iklAf}|yEcQcF{m@{Ow`@gJ_D{@_IcBkRsDsIoA_S_D{JcBoKcBoF{@{OwBkH{@_SkCwLoAk\\sD"},{"mode":"driving","weight":17.095,"distance":412,"geometry":"k|qklArmzyEoPwGsIcBcLcB{JoAsIoAsIoAgJcBsDoA{@SgEcBgEkCsDkCgEsDoFoFkH_IkHcGwGgEcGkCcGcBkHoAsI{@sIg@wGR{Eb@SB","duration":20.127,"guidance_views":[{"overlay_ids":["JV_11484622862"],"base_id":"JV_11484622860","type":"jct","data_id":"1652918400"},{"overlay_ids":[],"base_id":"SI_1241914001A2","type":"signboard","data_id":"1652918400"}],"driving_side":"right","duration_typical":22.775,"weight_typical":19.346,"name":"","speedLimitSign":"vienna","maneuver":{"type":"off ramp","instruction":"Take exit 23 toward M-100\/Cobe\u00f1a\/Algete.","modifier":"slight right","bearing_after":21,"bearing_before":8,"location":[-3.58577,40.57647]},"speedLimitUnit":"km\/h","destinations":"M-100: Cobe\u00f1a, Algete","bannerInstructions":[{"primary":{"components":[{"mapbox_shield":{"text_color":"black","name":"default","display_ref":"N-I","base_url":"https:\/\/api.mapbox.com\/styles\/v1"},"type":"icon","text":"N-I"}],"type":"turn","modifier":"slight right","text":"N-I"},"distanceAlongGeometry":412}],"exits":"23","voiceInstructions":[{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">In a quarter mile, Bear right onto <say-as interpret-as=\"address\">N-I<\/say-as>.<\/prosody><\/amazon:effect><\/speak>","announcement":"In a quarter mile, Bear right onto N-I.","distanceAlongGeometry":382},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Bear right onto <say-as interpret-as=\"address\">N-I<\/say-as>.<\/prosody><\/amazon:effect><\/speak>","announcement":"Bear right onto N-I.","distanceAlongGeometry":100}],"intersections":[{"entry":[true,true,false],"in":2,"bearings":[8,21,188],"duration":5.055,"lanes":[{"indications":["straight"],"valid":false,"active":false},{"indications":["straight"],"valid":false,"active":false},{"indications":["straight"],"valid":false,"active":false},{"indications":["straight","slight right"],"valid_indication":"slight right","valid":true,"active":true}],"turn_duration":0.015,"mapbox_streets_v8":{"class":"secondary_link"},"is_urban":false,"admin_index":0,"out":1,"weight":4.284,"geometry_index":16,"location":[-3.58577,40.57647]},{"entry":[true,false],"in":1,"bearings":[10,189],"duration":3.36,"mapbox_streets_v8":{"class":"secondary_link"},"is_urban":false,"admin_index":0,"out":0,"weight":2.856,"geometry_index":20,"location":[-3.58549,40.57732]},{"entry":[true,false],"in":1,"bearings":[19,195],"duration":0.72,"mapbox_streets_v8":{"class":"secondary_link"},"is_urban":false,"admin_index":0,"out":0,"weight":0.612,"geometry_index":24,"location":[-3.58532,40.57793]},{"entry":[true,false],"in":1,"bearings":[29,199],"duration":9.6,"mapbox_streets_v8":{"class":"secondary_link"},"is_urban":false,"admin_index":0,"out":0,"weight":8.16,"geometry_index":26,"location":[-3.58526,40.57806]},{"bearings":[185,356],"entry":[false,true],"in":0,"mapbox_streets_v8":{"class":"secondary_link"},"is_urban":false,"admin_index":0,"out":1,"geometry_index":38,"location":[-3.58431,40.57966]}]},{"voiceInstructions":[{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">In 900 feet, Enter the roundabout and take the 4th exit toward <phoneme alphabet='nt-sampa' ph='au|to|\"Bi|a \"a \"u|no'>A-1<\/phoneme>.<\/prosody><\/amazon:effect><\/speak>","announcement":"In 900 feet, Enter the roundabout and take the 4th exit toward A-1.","distanceAlongGeometry":235},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Enter the roundabout and take the 4th exit toward <phoneme alphabet='nt-sampa' ph='au|to|\"Bi|a \"a \"u|no'>A-1<\/phoneme>, <phoneme alphabet='nt-sampa' ph='\"e|me kwa|\"ren|ta'>M-40<\/phoneme>.<\/prosody><\/amazon:effect><\/speak>","announcement":"Enter the roundabout and take the 4th exit toward A-1, M-40.","distanceAlongGeometry":102.222}],"intersections":[{"entry":[true,false,false],"in":1,"bearings":[6,174,189],"duration":2.43,"turn_weight":11.75,"turn_duration":0.014,"mapbox_streets_v8":{"class":"secondary"},"is_urban":false,"admin_index":0,"out":0,"weight":14.226,"geometry_index":41,"location":[-3.58434,40.57992]},{"entry":[true,false],"in":1,"bearings":[5,186],"duration":5.779,"turn_weight":0.5,"mapbox_streets_v8":{"class":"secondary"},"is_urban":true,"admin_index":0,"out":0,"weight":7.579,"geometry_index":42,"location":[-3.58428,40.58038]},{"entry":[true,false],"in":1,"bearings":[8,186],"duration":4.14,"turn_weight":0.5,"mapbox_streets_v8":{"class":"secondary"},"is_urban":true,"admin_index":0,"out":0,"weight":5.571,"geometry_index":45,"location":[-3.58414,40.58147]},{"bearings":[26,51,189],"entry":[true,true,false],"in":2,"turn_weight":0.75,"lanes":[{"indications":["straight"],"valid_indication":"straight","valid":true,"active":true},{"indications":["straight"],"valid_indication":"straight","valid":true,"active":true},{"indications":["right"],"valid":false,"active":false}],"turn_duration":0.02,"mapbox_streets_v8":{"class":"secondary"},"is_urban":true,"admin_index":0,"out":0,"geometry_index":48,"location":[-3.58406,40.58188]}],"bannerInstructions":[{"primary":{"components":[{"type":"icon","text":"A-1"},{"type":"delimiter","text":"\/"},{"type":"icon","text":"M-40"},{"type":"delimiter","text":"\/"},{"type":"icon","text":"M-30"},{"type":"delimiter","text":"\/"},{"type":"text","text":"Madrid"}],"degrees":359,"driving_side":"right","type":"roundabout","modifier":"straight","text":"A-1 \/ M-40 \/ M-30 \/ Madrid"},"distanceAlongGeometry":265}],"speedLimitUnit":"km\/h","maneuver":{"type":"turn","instruction":"Bear right onto N-I.","modifier":"slight right","bearing_after":6,"bearing_before":354,"location":[-3.58434,40.57992]},"speedLimitSign":"vienna","name":"","weight_typical":36.087,"duration_typical":15.235,"duration":16.509,"distance":265,"driving_side":"right","weight":33.198,"mode":"driving","ref":"N-I","geometry":"_txklAftwyEw[wB_l@sDwL{@kHg@sI{@{Eg@cG{@gEcBkCwBcBkCoA_DoAsD"},{"voiceInstructions":[{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Exit the roundabout toward <phoneme alphabet='nt-sampa' ph='au|to|\"Bi|a \"a \"u|no'>A-1<\/phoneme>, <phoneme alphabet='nt-sampa' ph='\"e|me kwa|\"ren|ta'>M-40<\/phoneme>.<\/prosody><\/amazon:effect><\/speak>","announcement":"Exit the roundabout toward A-1, M-40.","distanceAlongGeometry":80}],"intersections":[{"entry":[true,false,false],"in":1,"bearings":[65,236,277],"duration":2.149,"turn_weight":5.5,"turn_duration":0.012,"mapbox_streets_v8":{"class":"roundabout"},"is_urban":true,"admin_index":0,"out":0,"weight":8.118,"geometry_index":53,"location":[-3.58371,40.58218]},{"entry":[true,true,false],"in":2,"bearings":[32,69,245],"duration":2.514,"turn_duration":0.223,"mapbox_streets_v8":{"class":"roundabout"},"is_urban":true,"admin_index":0,"out":0,"weight":2.806,"geometry_index":56,"location":[-3.58351,40.58225]},{"entry":[true,false],"in":1,"bearings":[0,212],"duration":1.705,"mapbox_streets_v8":{"class":"roundabout"},"is_urban":true,"admin_index":0,"out":0,"weight":2.089,"geometry_index":61,"location":[-3.58338,40.58241]},{"entry":[false,false,true],"in":1,"bearings":[114,180,329],"duration":4.639,"turn_duration":0.192,"mapbox_streets_v8":{"class":"roundabout"},"is_urban":true,"admin_index":0,"out":2,"weight":5.448,"geometry_index":64,"location":[-3.58338,40.58257]},{"entry":[false,true,true],"in":0,"bearings":[115,260,341],"duration":5.659,"turn_duration":0.259,"mapbox_streets_v8":{"class":"roundabout"},"is_urban":true,"admin_index":0,"out":1,"weight":6.615,"geometry_index":70,"location":[-3.58373,40.58281]},{"bearings":[24,177,290],"entry":[false,true,true],"in":0,"turn_duration":0.142,"mapbox_streets_v8":{"class":"roundabout"},"is_urban":true,"admin_index":0,"out":1,"geometry_index":77,"location":[-3.58418,40.58254]}],"destinations":"A-1, M-40, M-30: Madrid, S. Sebasti\u00e1n de los Reyes, Hospital","bannerInstructions":[{"primary":{"components":[{"type":"icon","text":"A-1"},{"type":"delimiter","text":"\/"},{"type":"icon","text":"M-40"},{"type":"delimiter","text":"\/"},{"type":"icon","text":"M-30"},{"type":"delimiter","text":"\/"},{"type":"text","text":"Madrid"}],"degrees":359,"driving_side":"right","type":"roundabout","modifier":"straight","text":"A-1 \/ M-40 \/ M-30 \/ Madrid"},"distanceAlongGeometry":173}],"speedLimitUnit":"km\/h","maneuver":{"type":"roundabout","exit":4,"instruction":"Enter the roundabout and take the 4th exit toward A-1\/M-40\/M-30\/Madrid.","modifier":"straight","bearing_after":65,"bearing_before":56,"location":[-3.58371,40.58218]},"speedLimitSign":"vienna","name":"","weight_typical":25.823,"duration_typical":16.398,"duration":18.946,"distance":173,"driving_side":"right","weight":27.695,"mode":"driving","ref":"N-I","geometry":"ga}klAzlvyESkC{@_D{@cBoAcB{@{@oA{@i@Qy@UwBScB?cBRkCz@cBnAcBjC{@vB{@~CSjC?fEf@zEz@jCbBjCbBbBvBz@vBf@bB?vB?vBS"},{"voiceInstructions":[{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">In a quarter mile, Take the <phoneme alphabet='nt-sampa' ph='au|to|\"Bi|a \"a \"u|no'>A-1<\/phoneme> ramp.<\/prosody><\/amazon:effect><\/speak>","announcement":"In a quarter mile, Take the A-1 ramp.","distanceAlongGeometry":446},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Take the <phoneme alphabet='nt-sampa' ph='au|to|\"Bi|a \"a \"u|no'>A-1<\/phoneme> ramp toward <phoneme alphabet='nt-sampa' ph='\"e|me kwa|\"ren|ta'>M-40<\/phoneme>, <phoneme alphabet='nt-sampa' ph='\"e|me \"trein|ta'>M-30<\/phoneme>.<\/prosody><\/amazon:effect><\/speak>","announcement":"Take the A-1 ramp toward M-40, M-30.","distanceAlongGeometry":200}],"intersections":[{"entry":[true,true,false],"in":2,"bearings":[139,177,357],"duration":3.213,"turn_weight":5.5,"turn_duration":0.019,"mapbox_streets_v8":{"class":"secondary"},"is_urban":false,"admin_index":0,"out":1,"weight":8.773,"geometry_index":80,"location":[-3.58417,40.58237]},{"entry":[false,true],"in":0,"bearings":[12,190],"duration":2.206,"turn_weight":0.5,"mapbox_streets_v8":{"class":"secondary"},"is_urban":false,"admin_index":0,"out":1,"weight":2.375,"geometry_index":84,"location":[-3.58423,40.58188]},{"entry":[false,true],"in":0,"bearings":[7,185],"duration":2.09,"turn_weight":0.5,"mapbox_streets_v8":{"class":"secondary"},"is_urban":false,"admin_index":0,"out":1,"weight":2.277,"geometry_index":87,"location":[-3.5843,40.58154]},{"entry":[false,true],"in":0,"bearings":[5,185],"duration":1.219,"turn_weight":0.5,"mapbox_streets_v8":{"class":"secondary"},"is_urban":false,"admin_index":0,"out":1,"weight":1.536,"geometry_index":88,"location":[-3.58434,40.58122]},{"entry":[false,true],"in":0,"bearings":[5,185],"duration":7.258,"turn_weight":0.5,"mapbox_streets_v8":{"class":"secondary"},"is_urban":false,"admin_index":0,"out":1,"weight":6.669,"geometry_index":89,"location":[-3.58436,40.58103]},{"entry":[false,true],"in":0,"bearings":[5,186],"duration":6.677,"turn_weight":0.5,"mapbox_streets_v8":{"class":"secondary"},"is_urban":false,"admin_index":0,"out":1,"weight":6.176,"geometry_index":90,"location":[-3.58449,40.57991]},{"entry":[false,true],"in":0,"bearings":[43,231],"duration":1.161,"turn_weight":0.5,"mapbox_streets_v8":{"class":"secondary"},"is_urban":false,"admin_index":0,"out":1,"weight":1.487,"geometry_index":98,"location":[-3.58499,40.57898]},{"entry":[false,true],"in":0,"bearings":[51,242],"duration":2.613,"turn_weight":0.75,"mapbox_streets_v8":{"class":"secondary"},"is_urban":false,"admin_index":0,"out":1,"weight":2.971,"geometry_index":100,"location":[-3.58517,40.57887]},{"bearings":[71,261],"entry":[false,true],"in":0,"turn_weight":0.5,"mapbox_streets_v8":{"class":"secondary"},"is_urban":false,"admin_index":0,"out":1,"geometry_index":104,"location":[-3.58565,40.57871]}],"bannerInstructions":[{"secondary":{"components":[{"mapbox_shield":{"text_color":"black","name":"default","display_ref":"M-40","base_url":"https:\/\/api.mapbox.com\/styles\/v1"},"type":"icon","text":"M-40"},{"type":"delimiter","text":"\/"},{"mapbox_shield":{"text_color":"black","name":"default","display_ref":"M-30","base_url":"https:\/\/api.mapbox.com\/styles\/v1"},"type":"icon","text":"M-30"}],"type":"turn","modifier":"slight right","text":"M-40 \/ M-30"},"primary":{"components":[{"type":"icon","text":"A-1"}],"type":"turn","modifier":"slight right","text":"A-1"},"distanceAlongGeometry":476}],"destinations":"A-1, M-40, M-30: Madrid, S. Sebasti\u00e1n de los Reyes, Hospital","speedLimitUnit":"km\/h","maneuver":{"type":"exit roundabout","instruction":"Exit the roundabout toward A-1\/M-40\/M-30\/Madrid.","modifier":"straight","bearing_after":177,"bearing_before":177,"location":[-3.58417,40.58237]},"speedLimitSign":"vienna","name":"","weight_typical":27.569,"duration_typical":19.059,"duration":27.584,"distance":476,"driving_side":"right","weight":33.739,"mode":"driving","ref":"N-I","geometry":"cm}klAriwyEzEg@nFRnFz@vGnAzEz@zEf@nFf@~RnAzJf@~dAbGjHf@vGz@zEz@nFbBnFjCzErDfEfE~CzEvBrDbBrDnArD~CbLf@~Cf@fEf@zERvG"},{"ref":"A-1; E-5","mode":"driving","weight":77.472,"distance":1426,"geometry":"ofvklAvuzyEoAfJg@zE{@zEwBbGwB~CkCvB_DbBsDf@sDS{EoA_DwBkC_DcBsDoAcGg@{E?gEf@gEz@{EvB{EjCsD~CwBrD{@zEg@fE?rDRzEf@fEf@nFz@vGf@tCi@`Ce@nPvBrNvB~RjCvQvBjW~CzTjCnU~CbV~C~RjC~MvBfOvB~MvBfJnAvLvBnUfEjRrD~MjCbLjCbQfEzTbGfTbGfTbG~RbGvLrDrIjCnKrDvLfEfObGfTrIzYvLrSfJb[zO","duration":64.147,"driving_side":"right","duration_typical":72.903,"weight_typical":84.914,"name":"Autov\u00eda del Norte","speedLimitSign":"vienna","maneuver":{"type":"on ramp","instruction":"Take the A-1 ramp toward M-40\/M-30\/M-50\/R-2.","modifier":"slight right","bearing_after":286,"bearing_before":261,"location":[-3.5859,40.57868]},"speedLimitUnit":"km\/h","pronunciation":"au|to|\"Bi|a %del \"nor|te","destinations":"A-1, M-40, M-30, M-50, R-2: Madrid, Zona Industrial, S. Sebasti\u00e1n de los Reyes","bannerInstructions":[{"view":{"components":[{"imageURL":"https:\/\/api.mapbox.com\/guidance-views\/v1\/1652918400\/jct\/JV_8115959870?arrow_ids=JV_8115959871","subType":"jct","type":"guidance-view","text":""},{"imageURL":"https:\/\/api.mapbox.com\/guidance-views\/v1\/1652918400\/signboard\/SR_ES_811595987A1","subType":"signboard","type":"guidance-view","text":""}],"type":"fork","modifier":"left","text":""},"secondary":{"components":[{"mapbox_shield":{"text_color":"black","name":"default","display_ref":"M-40","base_url":"https:\/\/api.mapbox.com\/styles\/v1"},"type":"icon","text":"M-40"},{"type":"delimiter","text":"\/"},{"mapbox_shield":{"text_color":"black","name":"default","display_ref":"M-30","base_url":"https:\/\/api.mapbox.com\/styles\/v1"},"type":"icon","text":"M-30"}],"type":"fork","modifier":"left","text":"M-40 \/ M-30"},"primary":{"components":[{"type":"icon","text":"A-1"}],"type":"fork","modifier":"left","text":"A-1"},"distanceAlongGeometry":1426}],"voiceInstructions":[{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">In 1 mile, Keep left to stay on <phoneme alphabet='nt-sampa' ph='au|to|\"Bi|a \"a \"u|no'>A-1<\/phoneme>.<\/prosody><\/amazon:effect><\/speak>","announcement":"In 1 mile, Keep left to stay on A-1.","distanceAlongGeometry":1416},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">In a half mile, Keep left to stay on <phoneme alphabet='nt-sampa' ph='au|to|\"Bi|a \"a \"u|no'>A-1<\/phoneme>.<\/prosody><\/amazon:effect><\/speak>","announcement":"In a half mile, Keep left to stay on A-1.","distanceAlongGeometry":804.672},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Keep left to stay on <phoneme alphabet='nt-sampa' ph='au|to|\"Bi|a \"a \"u|no'>A-1<\/phoneme>, <phoneme alphabet='nt-sampa' ph='\"e \"TiN|ko'>E-5<\/phoneme> toward <phoneme alphabet='nt-sampa' ph='\"e|me kwa|\"ren|ta'>M-40<\/phoneme>, <phoneme alphabet='nt-sampa' ph='\"e|me \"trein|ta'>M-30<\/phoneme>.<\/prosody><\/amazon:effect><\/speak>","announcement":"Keep left to stay on A-1, E-5 toward M-40, M-30.","distanceAlongGeometry":320}],"intersections":[{"entry":[false,true,true],"in":0,"bearings":[81,270,286],"duration":1.591,"turn_weight":2.25,"turn_duration":0.035,"mapbox_streets_v8":{"class":"secondary_link"},"is_urban":false,"admin_index":0,"out":2,"weight":3.573,"geometry_index":106,"location":[-3.5859,40.57868]},{"entry":[false,true],"in":0,"bearings":[106,288],"duration":24.227,"mapbox_streets_v8":{"class":"secondary_link"},"is_urban":false,"admin_index":0,"out":1,"weight":20.593,"geometry_index":107,"location":[-3.58608,40.57872]},{"entry":[false,true],"in":0,"bearings":[2,188],"duration":2.335,"mapbox_streets_v8":{"class":"secondary_link"},"is_urban":false,"admin_index":0,"out":1,"weight":1.985,"geometry_index":131,"location":[-3.58551,40.57894]},{"entry":[false,true],"in":0,"bearings":[8,189],"duration":2.822,"mapbox_streets_v8":{"class":"secondary_link"},"is_urban":false,"admin_index":0,"out":1,"weight":2.398,"geometry_index":133,"location":[-3.58555,40.57873]},{"entry":[false,true],"in":0,"bearings":[7,168],"duration":1.694,"mapbox_streets_v8":{"class":"secondary_link"},"is_urban":false,"admin_index":0,"out":1,"weight":1.44,"geometry_index":135,"location":[-3.5856,40.57847]},{"mapbox_streets_v8":{"class":"motorway"},"location":[-3.58556,40.57833],"geometry_index":137,"admin_index":0,"weight":22.219,"is_urban":false,"turn_weight":20.75,"duration":1.756,"bearings":[10,189,348],"out":1,"in":2,"turn_duration":0.028,"classes":["motorway"],"entry":[false,true,false]},{"lanes":[{"indications":["straight"],"valid_indication":"straight","valid":true,"active":true},{"indications":["straight"],"valid_indication":"straight","valid":true,"active":true},{"indications":["straight"],"valid_indication":"straight","valid":true,"active":true},{"indications":["straight"],"valid_indication":"straight","valid":true,"active":true}],"entry":[false,true],"classes":["motorway"],"in":0,"bearings":[10,189],"duration":6.797,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"weight":5.777,"geometry_index":139,"location":[-3.58568,40.5778]},{"lanes":[{"indications":["straight"],"valid_indication":"straight","valid":true,"active":true},{"indications":["straight"],"valid_indication":"straight","valid":true,"active":true},{"indications":["straight"],"valid_indication":"straight","valid":true,"active":true},{"indications":["straight"],"valid_indication":"straight","valid":true,"active":true}],"entry":[false,true],"classes":["motorway"],"in":0,"bearings":[9,189],"duration":1.814,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"weight":1.542,"geometry_index":145,"location":[-3.58612,40.57571]},{"entry":[false,true],"classes":["motorway"],"in":0,"bearings":[11,190],"duration":1.642,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"weight":1.395,"geometry_index":147,"location":[-3.58625,40.57515]},{"entry":[false,true],"classes":["motorway"],"in":0,"bearings":[11,190],"duration":4.982,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"weight":4.235,"geometry_index":149,"location":[-3.58637,40.57465]},{"entry":[false,true],"classes":["motorway"],"in":0,"bearings":[14,195],"duration":5.472,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"weight":4.651,"geometry_index":155,"location":[-3.5868,40.57313]},{"entry":[false,true],"classes":["motorway"],"in":0,"bearings":[17,197],"duration":6.278,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"weight":5.337,"geometry_index":160,"location":[-3.58742,40.57149]},{"lanes":[{"indications":["straight"],"valid_indication":"straight","valid":true,"active":true},{"indications":["straight"],"valid_indication":"straight","valid":true,"active":true},{"indications":["straight","slight right"],"valid_indication":"straight","valid":true,"active":true},{"indications":["straight"],"valid_indication":"straight","valid":true,"active":true}],"bearings":[21,203],"entry":[false,true],"classes":["motorway"],"in":0,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"geometry_index":167,"location":[-3.58829,40.56965]}]},{"bannerInstructions":[{"primary":{"components":[{"type":"text","text":"Your destination will be on the right"}],"type":"arrive","modifier":"right","text":"Your destination will be on the right"},"distanceAlongGeometry":2556.294},{"primary":{"components":[{"type":"text","text":"Your destination is on the right"}],"type":"arrive","modifier":"right","text":"Your destination is on the right"},"distanceAlongGeometry":166.667}],"ref":"A-1; E-5","mode":"driving","weight":64.099,"distance":2556.294,"geometry":"kacklAfg`zEz^jRvV~M~a@vVzc@fYb[rSzObLzOvLjRfOnKrIfTjRrS~RzTbVvG~HvGrIjMbQvQrXbLvQrIrNnFrIjHvLr]jk@nKnPfh@jz@~iAnjBbe@ju@reAzdBvGnKzJnPbe@~u@jWja@nFrIjHvLbe@ju@j\\zh@bVr]zJ~MrIbLnFvGjMrNvLvLjMjMbGnFzO~MbLrIjMrIjM~HjHfEvGrD~MvGbQ~HjRjHvLfEbLrD~MpD","duration":74.257,"guidance_views":[{"overlay_ids":["JV_8115959871"],"base_id":"JV_8115959870","type":"jct","data_id":"1652918400"},{"overlay_ids":[],"base_id":"SR_ES_811595987A1","type":"signboard","data_id":"1652918400"}],"driving_side":"right","duration_typical":76.712,"weight_typical":66.185,"name":"Autov\u00eda del Norte","speedLimitSign":"vienna","maneuver":{"type":"fork","instruction":"Keep left to stay on A-1\/E-5\/Autov\u00eda del Norte toward M-40\/M-30\/Madrid\/Aeropuerto.","modifier":"slight left","bearing_after":205,"bearing_before":205,"location":[-3.58874,40.56887]},"speedLimitUnit":"km\/h","pronunciation":"au|to|\"Bi|a %del \"nor|te","destinations":"A-1, M-40, M-30: Madrid, Aeropuerto","voiceInstructions":[{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">In 1.5 miles, Your destination will be on the right.<\/prosody><\/amazon:effect><\/speak>","announcement":"In 1.5 miles, Your destination will be on the right.","distanceAlongGeometry":2516.294},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">In a half mile, Your destination will be on the right.<\/prosody><\/amazon:effect><\/speak>","announcement":"In a half mile, Your destination will be on the right.","distanceAlongGeometry":804.672},{"ssmlAnnouncement":"<speak><amazon:effect name=\"drc\"><prosody rate=\"1.08\">Your destination is on the right.<\/prosody><\/amazon:effect><\/speak>","announcement":"Your destination is on the right.","distanceAlongGeometry":166.667}],"intersections":[{"entry":[false,true,true],"classes":["motorway"],"in":0,"bearings":[25,205,218],"duration":8.993,"turn_duration":0.007,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"weight":7.638,"geometry_index":169,"location":[-3.58874,40.56887]},{"lanes":[{"indications":["straight"],"valid_indication":"straight","valid":true,"active":true},{"indications":["straight"],"valid_indication":"straight","valid":true,"active":true},{"indications":["straight"],"valid_indication":"straight","valid":true,"active":true}],"entry":[false,true],"classes":["motorway"],"in":0,"bearings":[29,211],"duration":12.643,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"weight":10.747,"geometry_index":174,"location":[-3.59042,40.56638]},{"entry":[false,true],"classes":["motorway"],"in":0,"bearings":[47,228],"duration":0.806,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"weight":0.685,"geometry_index":186,"location":[-3.59361,40.56329]},{"entry":[false,true],"classes":["motorway"],"in":0,"bearings":[48,227],"duration":0.576,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"weight":0.49,"geometry_index":187,"location":[-3.59386,40.56312]},{"entry":[false,true],"classes":["motorway"],"in":0,"bearings":[47,228],"duration":4.003,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"weight":3.403,"geometry_index":188,"location":[-3.59403,40.563]},{"entry":[false,true],"classes":["motorway"],"in":0,"bearings":[47,228],"duration":11.693,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"weight":9.939,"geometry_index":191,"location":[-3.59524,40.56216]},{"entry":[false,true],"classes":["motorway"],"in":0,"bearings":[47,228],"duration":6.048,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"weight":5.141,"geometry_index":194,"location":[-3.59878,40.55969]},{"mapbox_streets_v8":{"class":"motorway"},"location":[-3.60061,40.55842],"geometry_index":196,"admin_index":0,"weight":1.783,"is_urban":false,"turn_weight":1,"duration":0.93,"bearings":[28,47,228],"out":2,"in":1,"turn_duration":0.008,"classes":["motorway"],"entry":[false,false,true]},{"entry":[false,true],"classes":["motorway"],"in":0,"bearings":[48,228],"duration":2.909,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"weight":2.472,"geometry_index":197,"location":[-3.60089,40.55823]},{"entry":[false,true],"classes":["motorway"],"in":0,"bearings":[48,227],"duration":1.843,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"weight":1.567,"geometry_index":198,"location":[-3.60177,40.55762]},{"entry":[false,true],"classes":["motorway"],"in":0,"bearings":[47,227],"duration":0.576,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"weight":0.49,"geometry_index":199,"location":[-3.60232,40.55723]},{"entry":[false,true],"classes":["motorway"],"in":0,"bearings":[47,228],"duration":0.732,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"weight":0.622,"geometry_index":200,"location":[-3.60249,40.55711]},{"entry":[false,true],"classes":["motorway"],"in":0,"bearings":[48,227],"duration":15.951,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"weight":13.559,"geometry_index":201,"location":[-3.60271,40.55696]},{"entry":[false,true],"classes":["motorway"],"in":0,"bearings":[28,207],"duration":0.556,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"weight":0.473,"geometry_index":215,"location":[-3.60689,40.55328]},{"entry":[false,true],"classes":["motorway"],"in":0,"bearings":[27,206],"duration":0.498,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"weight":0.423,"geometry_index":216,"location":[-3.60699,40.55313]},{"entry":[false,true],"classes":["motorway"],"in":0,"bearings":[26,204],"duration":3.717,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":1,"weight":3.16,"geometry_index":217,"location":[-3.60708,40.55299]},{"bearings":[1,19,198],"entry":[false,false,true],"classes":["motorway"],"in":1,"turn_duration":0.007,"mapbox_streets_v8":{"class":"motorway"},"is_urban":false,"admin_index":0,"out":2,"geometry_index":221,"location":[-3.60763,40.55193]}]},{"voiceInstructions":[],"intersections":[{"bearings":[16],"entry":[true],"in":0,"admin_index":0,"geometry_index":223,"location":[-3.607809,40.55148]}],"bannerInstructions":[],"speedLimitUnit":"km\/h","maneuver":{"type":"arrive","instruction":"Your destination is on the right.","modifier":"right","bearing_after":0,"bearing_before":196,"location":[-3.607809,40.55148]},"speedLimitSign":"vienna","pronunciation":"au|to|\"Bi|a %del \"nor|te","name":"Autov\u00eda del Norte","weight_typical":0,"duration_typical":0,"duration":0,"distance":0,"driving_side":"right","weight":0,"mode":"driving","ref":"A-1; E-5","geometry":"obajlA`oe{E??"}],"distance":5828.338,"summary":"A-1, N-I"}],"routeOptions":{"baseUrl":"https:\/\/api.mapbox.com","user":"mapbox","profile":"driving-traffic","coordinates":"-122.4192,37.7627;-122.4183502,37.7653577;-122.4145371,37.7657253","language":"en","continue_straight":true,"roundabout_exits":true,"geometries":"polyline6","overview":"full","steps":true,"annotations":"congestion,maxspeed,speed,duration,distance,closure","voice_instructions":true,"banner_instructions":true,"voice_units":"imperial","enable_refresh":true},"geometry":"k_iklAf}|yEcQcF{m@{Ow`@gJ_D{@_IcBkRsDsIoA_S_D{JcBoKcBoF{@{OwBkH{@_SkCwLoAk\\sDoPwGsIcBcLcB{JoAsIoAsIoAgJcBsDoA{@SgEcBgEkCsDkCgEsDoFoFkH_IkHcGwGgEcGkCcGcBkHoAsI{@sIg@wGR{Eb@SBw[wB_l@sDwL{@kHg@sI{@{Eg@cG{@gEcBkCwBcBkCoA_DoAsDSkC{@_D{@cBoAcB{@{@oA{@i@Qy@UwBScB?cBRkCz@cBnAcBjC{@vB{@~CSjC?fEf@zEz@jCbBjCbBbBvBz@vBf@bB?vB?vBSzEg@nFRnFz@vGnAzEz@zEf@nFf@~RnAzJf@~dAbGjHf@vGz@zEz@nFbBnFjCzErDfEfE~CzEvBrDbBrDnArD~CbLf@~Cf@fEf@zERvGoAfJg@zE{@zEwBbGwB~CkCvB_DbBsDf@sDS{EoA_DwBkC_DcBsDoAcGg@{E?gEf@gEz@{EvB{EjCsD~CwBrD{@zEg@fE?rDRzEf@fEf@nFz@vGf@tCi@`Ce@nPvBrNvB~RjCvQvBjW~CzTjCnU~CbV~C~RjC~MvBfOvB~MvBfJnAvLvBnUfEjRrD~MjCbLjCbQfEzTbGfTbGfTbG~RbGvLrDrIjCnKrDvLfEfObGfTrIzYvLrSfJb[zOz^jRvV~M~a@vVzc@fYb[rSzObLzOvLjRfOnKrIfTjRrS~RzTbVvG~HvGrIjMbQvQrXbLvQrIrNnFrIjHvLr]jk@nKnPfh@jz@~iAnjBbe@ju@reAzdBvGnKzJnPbe@~u@jWja@nFrIjHvLbe@ju@j\\zh@bVr]zJ~MrIbLnFvGjMrNvLvLjMjMbGnFzO~MbLrIjMrIjM~HjHfEvGrD~MvGbQ~HjRjHvLfEbLrD~MpD","voiceLocale":"en-US"}""")
        .toNavigationRoute(RouterOrigin.Custom())
    private lateinit var mapboxMap: MapboxMap
    private lateinit var mapboxNavigation: MapboxNavigation
    private lateinit var binding: MapboxActivitySignboardBinding
    private lateinit var locationComponent: LocationComponentPlugin

    private val mapboxReplayer = MapboxReplayer()
    private val navigationLocationProvider = NavigationLocationProvider()

    /**
     * The [MapboxSignboardApi] consumes banner instructions data and produces signboard related
     * data that is consumed by the [MapboxSignboardView] in the view layout.
     *
     * * Uses a specific access token required for the route request to send signboards in the response.
     */
    private val signboardApi: MapboxSignboardApi by lazy {
        MapboxSignboardApi(getString(R.string.mapbox_access_token), applicationContext)
    }

    /**
     * The result of invoking [MapboxSignboardApi.generateSignboard] is returned as a callback
     * containing either a success in the form of [SignboardValue] or failure in the form of
     * [SignboardError].
     */
    private val signboardCallback =
        MapboxNavigationConsumer<Expected<SignboardError, SignboardValue>> { expected ->
            // The data obtained must be rendered by [MapboxSignboardView]
            binding.signboardView.isVisible = expected.isValue
            binding.signboardView.render(expected)
        }

    private val routeLineResources: RouteLineResources by lazy {
        RouteLineResources.Builder().build()
    }

    private val options: MapboxRouteLineOptions by lazy {
        MapboxRouteLineOptions.Builder(this)
            .withRouteLineResources(routeLineResources)
            .withRouteLineBelowLayerId("road-label")
            .build()
    }

    private val routeLineView by lazy {
        MapboxRouteLineView(options)
    }

    private val routeLineApi: MapboxRouteLineApi by lazy {
        MapboxRouteLineApi(options)
    }

    private val replayProgressObserver = ReplayProgressObserver(mapboxReplayer)

    private val locationObserver = object : LocationObserver {
        override fun onNewRawLocation(rawLocation: Location) {}
        override fun onNewLocationMatcherResult(locationMatcherResult: LocationMatcherResult) {
            navigationLocationProvider.changePosition(
                locationMatcherResult.enhancedLocation,
                locationMatcherResult.keyPoints,
            )
            updateCamera(locationMatcherResult.enhancedLocation)
        }
    }

    private val routesObserver = RoutesObserver { result ->
        if (result.navigationRoutes.isNotEmpty()) {
            lifecycleScope.launch {
                routeLineApi.setNavigationRoutes(listOf(result.navigationRoutes[0])).apply {
                    routeLineView.renderRouteDrawData(mapboxMap.getStyle()!!, this)
                }
            }
            startSimulation(result.navigationRoutes[0])
        }
    }

    private val bannerInstructionsObserver = BannerInstructionsObserver { bannerInstructions ->
        // The signboard component is driven by banner instructions updates.
        // Passing the instructions to the MapboxSignboardApi generates the data
        // for updating the view.
        signboardApi.generateSignboard(bannerInstructions, signboardCallback)
    }

    private fun init() {
        initNavigation()
        initStyle()
    }

    @SuppressLint("MissingPermission")
    private fun initNavigation() {
        mapboxNavigation = MapboxNavigationProvider.create(
            NavigationOptions.Builder(this)
                .accessToken(getString(R.string.mapbox_access_token))
                .locationEngine(ReplayLocationEngine(mapboxReplayer))
                .build()
        )
        mapboxNavigation.startTripSession()
        mapboxReplayer.pushRealLocation(this, 0.0)
        mapboxReplayer.play()
    }

    @SuppressLint("MissingPermission")
    private fun initStyle() {
        mapboxMap.loadStyleUri(Style.MAPBOX_STREETS) { style ->
            routeLineView.initializeLayers(style)
            binding.actionButton.setOnClickListener {
                mapboxNavigation.setNavigationRoutes(listOf(route))
                binding.actionButton.visibility = View.GONE
            }
        }
    }

    @SuppressLint("MissingPermission")
    private fun startSimulation(route: NavigationRoute) {
        mapboxReplayer.stop()
        mapboxReplayer.clearEvents()
        mapboxReplayer.pushRealLocation(this, 0.0)
        val replayEvents = ReplayRouteMapper().mapDirectionsRouteGeometry(route.directionsRoute)
        mapboxReplayer.pushEvents(replayEvents)
        mapboxReplayer.seekTo(replayEvents.first())
        mapboxReplayer.play()
    }

    private fun updateCamera(location: Location) {
        val mapAnimationOptionsBuilder = MapAnimationOptions.Builder()
        mapAnimationOptionsBuilder.duration(1500L)
        binding.mapView.camera.easeTo(
            CameraOptions.Builder()
                .center(Point.fromLngLat(location.longitude, location.latitude))
                .bearing(location.bearing.toDouble())
                .pitch(45.0)
                .zoom(17.0)
                .padding(EdgeInsets(1000.0, 0.0, 0.0, 0.0))
                .build(),
            mapAnimationOptionsBuilder.build()
        )
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // Look at LayoutActivitySignboardBinding to see the view component in the
        // activity's layout.
        binding = MapboxActivitySignboardBinding.inflate(layoutInflater)
        setContentView(binding.root)
        mapboxMap = binding.mapView.getMapboxMap()
        locationComponent = binding.mapView.location.apply {
            setLocationProvider(navigationLocationProvider)
            enabled = true
        }
        init()
    }

    override fun onStart() {
        super.onStart()
        mapboxNavigation.registerRoutesObserver(routesObserver)
        mapboxNavigation.registerLocationObserver(locationObserver)
        mapboxNavigation.registerRouteProgressObserver(replayProgressObserver)
        mapboxNavigation.registerBannerInstructionsObserver(bannerInstructionsObserver)
    }

    override fun onStop() {
        super.onStop()
        mapboxNavigation.unregisterRoutesObserver(routesObserver)
        mapboxNavigation.unregisterLocationObserver(locationObserver)
        mapboxNavigation.unregisterRouteProgressObserver(replayProgressObserver)
        mapboxNavigation.unregisterBannerInstructionsObserver(bannerInstructionsObserver)
    }

    override fun onDestroy() {
        super.onDestroy()
        routeLineApi.cancel()
        routeLineView.cancel()
        signboardApi.cancelAll()
        mapboxReplayer.finish()
        mapboxNavigation.onDestroy()
    }
}
