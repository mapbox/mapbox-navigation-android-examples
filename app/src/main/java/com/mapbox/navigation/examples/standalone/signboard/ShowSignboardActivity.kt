package com.mapbox.navigation.examples.standalone.signboard

import android.annotation.SuppressLint
import android.location.Location
import android.os.Bundle
import android.view.View
import androidx.appcompat.app.AppCompatActivity
import androidx.core.view.isVisible
import androidx.lifecycle.lifecycleScope
import com.mapbox.api.directions.v5.models.DirectionsRoute
import com.mapbox.bindgen.Expected
import com.mapbox.geojson.Point
import com.mapbox.maps.CameraOptions
import com.mapbox.maps.EdgeInsets
import com.mapbox.maps.plugin.animation.MapAnimationOptions
import com.mapbox.maps.plugin.animation.camera
import com.mapbox.maps.plugin.locationcomponent.location
import com.mapbox.navigation.base.ExperimentalPreviewMapboxNavigationAPI
import com.mapbox.navigation.base.options.NavigationOptions
import com.mapbox.navigation.base.route.RouterOrigin
import com.mapbox.navigation.base.route.toNavigationRoute
import com.mapbox.navigation.core.MapboxNavigation
import com.mapbox.navigation.core.directions.session.RoutesObserver
import com.mapbox.navigation.core.lifecycle.MapboxNavigationApp
import com.mapbox.navigation.core.lifecycle.MapboxNavigationObserver
import com.mapbox.navigation.core.lifecycle.requireMapboxNavigation
import com.mapbox.navigation.core.replay.MapboxReplayer
import com.mapbox.navigation.core.replay.ReplayLocationEngine
import com.mapbox.navigation.core.replay.route.ReplayProgressObserver
import com.mapbox.navigation.core.replay.route.ReplayRouteMapper
import com.mapbox.navigation.core.trip.session.BannerInstructionsObserver
import com.mapbox.navigation.core.trip.session.LocationMatcherResult
import com.mapbox.navigation.core.trip.session.LocationObserver
import com.mapbox.navigation.examples.R
import com.mapbox.navigation.examples.databinding.MapboxActivitySignboardBinding
import com.mapbox.navigation.ui.base.util.MapboxNavigationConsumer
import com.mapbox.navigation.ui.maps.NavigationStyles
import com.mapbox.navigation.ui.maps.guidance.signboard.api.MapboxSignboardApi
import com.mapbox.navigation.ui.maps.guidance.signboard.model.SignboardError
import com.mapbox.navigation.ui.maps.guidance.signboard.model.SignboardValue
import com.mapbox.navigation.ui.maps.guidance.signboard.view.MapboxSignboardView
import com.mapbox.navigation.ui.maps.location.NavigationLocationProvider
import com.mapbox.navigation.ui.maps.route.line.MapboxRouteLineApiExtensions.setNavigationRoutes
import com.mapbox.navigation.ui.maps.route.line.api.MapboxRouteLineApi
import com.mapbox.navigation.ui.maps.route.line.api.MapboxRouteLineView
import com.mapbox.navigation.ui.maps.route.line.model.MapboxRouteLineOptions
import com.mapbox.navigation.ui.maps.route.line.model.RouteLineResources
import kotlinx.coroutines.launch
import java.util.Date

/**
 * This activity demonstrates the usage of the [MapboxSignboardApi]. There is boiler plate
 * code for establishing basic navigation and a route simulator is used. The example assumes
 * that LOCATION permission has already been granted.
 *
 * The code specifically related to the signboard component is commented in order to call
 * attention to its usage. The example uses a predefined location pair to demonstrate signboard.
 * Click "Set Route" button to use predefined coordinates and trigger navigation.
 *
 * Note: A special access token is required to get access to signboards in directions response.
 */
@OptIn(ExperimentalPreviewMapboxNavigationAPI::class)
class ShowSignboardActivity : AppCompatActivity() {

    private val route = DirectionsRoute
        .fromJson("""{"country_crossed":false,"weight_typical":275.778,"routeIndex":"0","distance":5824.273,"duration":251.562,"duration_typical":247.195,"geometry":"k_iklAf}|yEcQcF{m@{Ow`@gJ_D{@_IcBkRsDsIoA_S_D{JcBoKcBoF{@{OwBkH{@_SkCwLoAk\\sDoPwGsIcBcLcB{JoAsIoAsIoAgJcBsDoA{@SgEcBgEkCsDkCgEsDoFoFkH_IkHcGwGgEcGkCcGcBkHoAsI{@sIg@wGR{Eb@SBw[wB_l@sDwL{@kHg@sI{@{Eg@cG{@gEcBkCwBcBkCoA_DgAaDGQSkC{@_D{@cBoAcB{@{@oA{@i@Qy@UwBScB?cBRkCz@cBnAcBjC{@vB{@~CSjC?fEf@zEz@jCbBjCbBbBvBz@vBf@bB?vB?vBS~H?rDRjCRrDf@rDf@~Cf@vGz@vGf@rNz@~WbBjz@zEvGf@jHz@zEz@nFbBrDbBjCbBrD~C~CrD~CfEvBrDbBrDnArDnAfEnAzEf@~Cf@fEf@vGL`DDx@oAbL{@nF{@rD{@jCoAjCcBvBcBnAcBz@cBf@oARwBRcB?wBSwBg@cB{@oA{@oAoA{@oA{@cB{@kCg@kCg@sDS_D?_DR_DRcBz@_Dz@wBz@cBbBwBvBcBvBoAjC{@vBg@vBSvB?rDRvBRrDf@rDf@nFz@~CRjC?fFKzDGnKnArNvB~RjCvQvBjW~CzTjCnU~CbV~C~RjC~MvBfOvB~MvBfJnAvLvBnUfEjRrD~MjCbLjCbQfEzTbGfTbGfTbG~RbGvLrDrIjCnKrDvLfEfObGfTrIzYvLrSfJb[zOz^jRvV~M~a@vVzc@fYb[rSzObLzOvLjRfOnKrIfTjRrS~RzTbVvG~HvGrIjMbQvQrXbLvQrIrNnFrIjHvLr]jk@nKnPfh@jz@~iAnjBbe@ju@reAzdBvGnKzJnPbe@~u@jWja@nFrIjHvLbe@ju@j\\zh@bVr]zJ~MrIbLnFvGjMrNvLvLjMjMbGnFzO~MbLrIjMrIjM~HjHfEvGrD~MvGbQ~HjRjHvLfEbLrD~MpD","weight":279.093,"weight_name":"auto","legs":[{"weight_typical":275.778,"weight":279.093,"via_waypoints":[],"distance":5824.273,"duration":251.562,"duration_typical":247.195,"summary":"A-1, N-I","admins":[{"iso_3166_1":"ES","iso_3166_1_alpha3":"ESP"}],"steps":[{"weight_typical":16.35,"distance":519.552,"duration":15.993,"duration_typical":19.235,"speedLimitUnit":"km/h","speedLimitSign":"vienna","geometry":"k_iklAf}|yEcQcF{m@{Ow`@gJ_D{@_IcBkRsDsIoA_S_D{JcBoKcBoF{@{OwBkH{@_SkCwLoAk\\sD","name":"Autovía del Norte","ref":"A-1; E-5","mode":"driving","pronunciation":"au|to|\"Bi|a %del \"nor|te","maneuver":{"location":[-3.587044,40.57191],"bearing_before":0.0,"bearing_after":17.0,"instruction":"Drive north on A-1/E-5/Autovía del Norte.","type":"depart"},"voiceInstructions":[{"distanceAlongGeometry":519.552,"announcement":"Drive north on A-1, E-5. Then Take exit 23.","ssmlAnnouncement":"\u003cspeak\u003e\u003camazon:effect name\u003d\"drc\"\u003e\u003cprosody rate\u003d\"1.08\"\u003eDrive north on \u003cphoneme alphabet\u003d\u0027nt-sampa\u0027 ph\u003d\u0027au|to|\"Bi|a \"a \"u|no\u0027\u003eA-1\u003c/phoneme\u003e, \u003cphoneme alphabet\u003d\u0027nt-sampa\u0027 ph\u003d\u0027\"e \"TiN|ko\u0027\u003eE-5\u003c/phoneme\u003e. Then Take exit \u003csay-as interpret-as\u003d\"address\"\u003e23\u003c/say-as\u003e.\u003c/prosody\u003e\u003c/amazon:effect\u003e\u003c/speak\u003e"},{"distanceAlongGeometry":226.667,"announcement":"Take exit 23 toward M-100, Cobeña.","ssmlAnnouncement":"\u003cspeak\u003e\u003camazon:effect name\u003d\"drc\"\u003e\u003cprosody rate\u003d\"1.08\"\u003eTake exit \u003csay-as interpret-as\u003d\"address\"\u003e23\u003c/say-as\u003e toward \u003cphoneme alphabet\u003d\u0027nt-sampa\u0027 ph\u003d\u0027\"e|me \"Tjen\u0027\u003eM-100\u003c/phoneme\u003e, \u003cphoneme alphabet\u003d\u0027nt-sampa\u0027 ph\u003d\u0027ko|\"Be|Ja\u0027\u003eCobeña\u003c/phoneme\u003e.\u003c/prosody\u003e\u003c/amazon:effect\u003e\u003c/speak\u003e"}],"bannerInstructions":[{"distanceAlongGeometry":519.552,"primary":{"text":"Exit 23 M-100 / Cobeña","components":[{"text":"Exit","type":"exit"},{"text":"23","type":"exit-number"},{"text":"M-100","type":"icon","mapbox_shield":{"base_url":"https://api.mapbox.com/styles/v1","name":"default","text_color":"black","display_ref":"M-100"}},{"text":"/","type":"delimiter"},{"text":"Cobeña","type":"text"}],"type":"off ramp","modifier":"right"},"sub":{"text":"","components":[{"text":"","type":"lane","directions":["straight"],"active":false},{"text":"","type":"lane","directions":["straight"],"active":false},{"text":"","type":"lane","directions":["straight"],"active":false},{"text":"","type":"lane","directions":["straight","slight right"],"active":true,"active_direction":"slight right"}]},"view":{"text":"","components":[{"text":"","type":"guidance-view","subType":"jct","imageURL":"https://api.mapbox.com/guidance-views/v1/1662595200/jct/JV_11484622860?arrow_ids\u003dJV_11484622862"},{"text":"","type":"guidance-view","subType":"signboard","imageURL":"https://api.mapbox.com/guidance-views/v1/1662595200/signboard/SI_1241914001A2"}],"type":"off ramp","modifier":"right"}}],"driving_side":"right","weight":13.594,"intersections":[{"duration":1.039,"weight":0.883,"location":[-3.587044,40.57191],"bearings":[17],"classes":["motorway"],"entry":[true],"out":0,"geometry_index":0,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":2.677,"weight":2.275,"location":[-3.58693,40.5722],"bearings":[15,197],"classes":["motorway"],"entry":[true,false],"in":1,"out":0,"geometry_index":1,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":1.908,"weight":1.622,"location":[-3.58666,40.57295],"bearings":[14,195],"classes":["motorway"],"entry":[true,false],"in":1,"out":0,"geometry_index":2,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":3.631,"weight":3.086,"location":[-3.58648,40.57349],"bearings":[14,194],"classes":["motorway"],"entry":[true,false],"in":1,"out":0,"geometry_index":3,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":1.354,"weight":1.151,"location":[-3.58619,40.57453],"bearings":[11,191],"classes":["motorway"],"entry":[true,false],"in":1,"out":0,"geometry_index":8,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"location":[-3.58609,40.57492],"bearings":[10,191],"classes":["motorway"],"entry":[true,false],"in":1,"out":0,"lanes":[{"valid":false,"active":false,"indications":["straight"]},{"valid":false,"active":false,"indications":["straight"]},{"valid":false,"active":false,"indications":["straight"]},{"valid":true,"active":true,"valid_indication":"slight right","indications":["straight","slight right"]}],"geometry_index":10,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}}]},{"guidance_views":[{"overlay_ids":["JV_11484622862"],"base_id":"JV_11484622860","type":"jct","data_id":"1662595200"},{"overlay_ids":[],"base_id":"SI_1241914001A2","type":"signboard","data_id":"1662595200"}],"weight_typical":19.909,"distance":411.391,"duration":19.632,"duration_typical":23.437,"speedLimitUnit":"km/h","speedLimitSign":"vienna","geometry":"k|qklArmzyEoPwGsIcBcLcB{JoAsIoAsIoAgJcBsDoA{@SgEcBgEkCsDkCgEsDoFoFkH_IkHcGwGgEcGkCcGcBkHoAsI{@sIg@wGR{Eb@SB","name":"","destinations":"M-100: Cobeña, Algete","mode":"driving","maneuver":{"location":[-3.58577,40.57647],"bearing_before":8.0,"bearing_after":21.0,"instruction":"Take exit 23 toward M-100/Cobeña/Algete.","type":"off ramp","modifier":"slight right"},"voiceInstructions":[{"distanceAlongGeometry":381.391,"announcement":"In a quarter mile, Bear right onto N-I.","ssmlAnnouncement":"\u003cspeak\u003e\u003camazon:effect name\u003d\"drc\"\u003e\u003cprosody rate\u003d\"1.08\"\u003eIn a quarter mile, Bear right onto \u003csay-as interpret-as\u003d\"address\"\u003eN-I\u003c/say-as\u003e.\u003c/prosody\u003e\u003c/amazon:effect\u003e\u003c/speak\u003e"},{"distanceAlongGeometry":100.0,"announcement":"Bear right onto N-I.","ssmlAnnouncement":"\u003cspeak\u003e\u003camazon:effect name\u003d\"drc\"\u003e\u003cprosody rate\u003d\"1.08\"\u003eBear right onto \u003csay-as interpret-as\u003d\"address\"\u003eN-I\u003c/say-as\u003e.\u003c/prosody\u003e\u003c/amazon:effect\u003e\u003c/speak\u003e"}],"bannerInstructions":[{"distanceAlongGeometry":411.391,"primary":{"text":"N-I","components":[{"text":"N-I","type":"icon","mapbox_shield":{"base_url":"https://api.mapbox.com/styles/v1","name":"default","text_color":"black","display_ref":"N-I"}}],"type":"turn","modifier":"slight right"}}],"driving_side":"right","weight":16.674,"intersections":[{"duration":4.915,"turn_duration":0.015,"weight":4.165,"location":[-3.58577,40.57647],"bearings":[8,21,188],"entry":[true,true,false],"in":2,"out":1,"lanes":[{"valid":false,"active":false,"indications":["straight"]},{"valid":false,"active":false,"indications":["straight"]},{"valid":false,"active":false,"indications":["straight"]},{"valid":true,"active":true,"valid_indication":"slight right","indications":["straight","slight right"]}],"geometry_index":16,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"secondary_link"}},{"duration":3.273,"weight":2.782,"location":[-3.58549,40.57732],"bearings":[10,189],"entry":[true,false],"in":1,"out":0,"geometry_index":20,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"secondary_link"}},{"duration":0.701,"weight":0.596,"location":[-3.58532,40.57793],"bearings":[19,195],"entry":[true,false],"in":1,"out":0,"geometry_index":24,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"secondary_link"}},{"duration":9.351,"weight":7.948,"location":[-3.58526,40.57806],"bearings":[29,199],"entry":[true,false],"in":1,"out":0,"geometry_index":26,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"secondary_link"}},{"location":[-3.58431,40.57966],"bearings":[185,356],"entry":[false,true],"in":0,"out":1,"geometry_index":38,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"secondary_link"}}],"exits":"23"},{"weight_typical":35.298,"distance":265.764,"duration":18.591,"duration_typical":18.258,"speedLimitUnit":"km/h","speedLimitSign":"vienna","geometry":"_txklAftwyEw[wB_l@sDwL{@kHg@sI{@{Eg@cG{@gEcBkCwBcBkCoA_DgAaDGQ","name":"","ref":"N-I","mode":"driving","maneuver":{"location":[-3.58434,40.57992],"bearing_before":354.0,"bearing_after":6.0,"instruction":"Bear right onto N-I.","type":"turn","modifier":"slight right"},"voiceInstructions":[{"distanceAlongGeometry":235.764,"announcement":"In 900 feet, Enter the roundabout and take the 4th exit toward A-1.","ssmlAnnouncement":"\u003cspeak\u003e\u003camazon:effect name\u003d\"drc\"\u003e\u003cprosody rate\u003d\"1.08\"\u003eIn 900 feet, Enter the roundabout and take the 4th exit toward \u003cphoneme alphabet\u003d\u0027nt-sampa\u0027 ph\u003d\u0027au|to|\"Bi|a \"a \"u|no\u0027\u003eA-1\u003c/phoneme\u003e.\u003c/prosody\u003e\u003c/amazon:effect\u003e\u003c/speak\u003e"},{"distanceAlongGeometry":102.222,"announcement":"Enter the roundabout and take the 4th exit toward A-1, M-40.","ssmlAnnouncement":"\u003cspeak\u003e\u003camazon:effect name\u003d\"drc\"\u003e\u003cprosody rate\u003d\"1.08\"\u003eEnter the roundabout and take the 4th exit toward \u003cphoneme alphabet\u003d\u0027nt-sampa\u0027 ph\u003d\u0027au|to|\"Bi|a \"a \"u|no\u0027\u003eA-1\u003c/phoneme\u003e, \u003cphoneme alphabet\u003d\u0027nt-sampa\u0027 ph\u003d\u0027\"e|me kwa|\"ren|ta\u0027\u003eM-40\u003c/phoneme\u003e.\u003c/prosody\u003e\u003c/amazon:effect\u003e\u003c/speak\u003e"}],"bannerInstructions":[{"distanceAlongGeometry":265.764,"primary":{"text":"A-1 / M-40 / M-30 / Madrid","components":[{"text":"A-1","type":"icon"},{"text":"/","type":"delimiter"},{"text":"M-40","type":"icon"},{"text":"/","type":"delimiter"},{"text":"M-30","type":"icon"},{"text":"/","type":"delimiter"},{"text":"Madrid","type":"text"}],"type":"roundabout","modifier":"straight","degrees":359.0,"driving_side":"right"}}],"driving_side":"right","weight":35.657,"intersections":[{"duration":2.883,"turn_weight":11.75,"turn_duration":0.014,"weight":14.69,"location":[-3.58434,40.57992],"bearings":[6,174,189],"entry":[true,false,false],"in":1,"out":0,"geometry_index":41,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"secondary"}},{"duration":6.971,"turn_weight":0.5,"weight":9.04,"location":[-3.58428,40.58038],"bearings":[5,186],"entry":[true,false],"in":1,"out":0,"geometry_index":42,"is_urban":true,"admin_index":0,"mapbox_streets_v8":{"class":"secondary"}},{"duration":4.358,"turn_weight":0.5,"weight":5.838,"location":[-3.58414,40.58147],"bearings":[8,186],"entry":[true,false],"in":1,"out":0,"geometry_index":45,"is_urban":true,"admin_index":0,"mapbox_streets_v8":{"class":"secondary"}},{"turn_weight":0.75,"turn_duration":0.02,"location":[-3.58406,40.58188],"bearings":[26,51,189],"entry":[true,true,false],"in":2,"out":0,"lanes":[{"valid":true,"active":true,"valid_indication":"straight","indications":["straight"]},{"valid":true,"active":true,"valid_indication":"straight","indications":["straight"]},{"valid":false,"active":false,"indications":["right"]}],"geometry_index":48,"is_urban":true,"admin_index":0,"mapbox_streets_v8":{"class":"secondary"},"yield_sign":true}]},{"weight_typical":25.175,"distance":173.564,"duration":18.197,"duration_typical":16.889,"speedLimitUnit":"km/h","speedLimitSign":"vienna","geometry":"ga}klAzlvyESkC{@_D{@cBoAcB{@{@oA{@i@Qy@UwBScB?cBRkCz@cBnAcBjC{@vB{@~CSjC?fEf@zEz@jCbBjCbBbBvBz@vBf@bB?vB?vBS","name":"","ref":"N-I","destinations":"A-1, M-40, M-30: Madrid, S. Sebastián de los Reyes, Hospital","mode":"driving","maneuver":{"location":[-3.58371,40.58218],"bearing_before":56.0,"bearing_after":65.0,"instruction":"Enter the roundabout and take the 4th exit toward A-1/M-40/M-30/Madrid.","type":"roundabout","modifier":"straight","exit":4},"voiceInstructions":[{"distanceAlongGeometry":80.0,"announcement":"Exit the roundabout toward A-1, M-40.","ssmlAnnouncement":"\u003cspeak\u003e\u003camazon:effect name\u003d\"drc\"\u003e\u003cprosody rate\u003d\"1.08\"\u003eExit the roundabout toward \u003cphoneme alphabet\u003d\u0027nt-sampa\u0027 ph\u003d\u0027au|to|\"Bi|a \"a \"u|no\u0027\u003eA-1\u003c/phoneme\u003e, \u003cphoneme alphabet\u003d\u0027nt-sampa\u0027 ph\u003d\u0027\"e|me kwa|\"ren|ta\u0027\u003eM-40\u003c/phoneme\u003e.\u003c/prosody\u003e\u003c/amazon:effect\u003e\u003c/speak\u003e"}],"bannerInstructions":[{"distanceAlongGeometry":173.564,"primary":{"text":"A-1 / M-40 / M-30 / Madrid","components":[{"text":"A-1","type":"icon"},{"text":"/","type":"delimiter"},{"text":"M-40","type":"icon"},{"text":"/","type":"delimiter"},{"text":"M-30","type":"icon"},{"text":"/","type":"delimiter"},{"text":"Madrid","type":"text"}],"type":"roundabout","modifier":"straight","degrees":359.0,"driving_side":"right"}}],"driving_side":"right","weight":26.777,"intersections":[{"duration":1.912,"turn_weight":5.5,"turn_duration":0.012,"weight":7.827,"location":[-3.58371,40.58218],"bearings":[65,236,277],"entry":[true,false,false],"in":1,"out":0,"geometry_index":54,"is_urban":true,"admin_index":0,"mapbox_streets_v8":{"class":"roundabout"}},{"duration":2.323,"turn_duration":0.223,"weight":2.573,"location":[-3.58351,40.58225],"bearings":[32,69,245],"entry":[true,true,false],"in":2,"out":0,"geometry_index":57,"is_urban":true,"admin_index":0,"mapbox_streets_v8":{"class":"roundabout"}},{"duration":1.906,"weight":2.335,"location":[-3.58338,40.58241],"bearings":[0,212],"entry":[true,false],"in":1,"out":0,"geometry_index":62,"is_urban":true,"admin_index":0,"mapbox_streets_v8":{"class":"roundabout"}},{"duration":4.639,"turn_duration":0.192,"weight":5.448,"location":[-3.58338,40.58257],"bearings":[114,180,329],"entry":[false,false,true],"in":1,"out":2,"geometry_index":65,"is_urban":true,"admin_index":0,"mapbox_streets_v8":{"class":"roundabout"}},{"duration":5.375,"turn_duration":0.259,"weight":6.267,"location":[-3.58373,40.58281],"bearings":[115,260,341],"entry":[false,true,true],"in":0,"out":1,"geometry_index":71,"is_urban":true,"admin_index":0,"mapbox_streets_v8":{"class":"roundabout"}},{"turn_duration":0.142,"location":[-3.58418,40.58254],"bearings":[24,177,290],"entry":[false,true,true],"in":0,"out":1,"geometry_index":78,"is_urban":true,"admin_index":0,"mapbox_streets_v8":{"class":"roundabout"}}]},{"weight_typical":27.36,"distance":475.806,"duration":33.036,"duration_typical":19.089,"speedLimitUnit":"km/h","speedLimitSign":"vienna","geometry":"cm}klAriwyE~H?rDRjCRrDf@rDf@~Cf@vGz@vGf@rNz@~WbBjz@zEvGf@jHz@zEz@nFbBrDbBjCbBrD~C~CrD~CfEvBrDbBrDnArDnAfEnAzEf@~Cf@fEf@vGL`DDx@","name":"","ref":"N-I","destinations":"A-1, M-40, M-30: Madrid, S. Sebastián de los Reyes, Hospital","mode":"driving","maneuver":{"location":[-3.58417,40.58237],"bearing_before":177.0,"bearing_after":181.0,"instruction":"Exit the roundabout toward A-1/M-40/M-30/Madrid.","type":"exit roundabout","modifier":"straight"},"voiceInstructions":[{"distanceAlongGeometry":445.806,"announcement":"In a quarter mile, Take the A-1 ramp.","ssmlAnnouncement":"\u003cspeak\u003e\u003camazon:effect name\u003d\"drc\"\u003e\u003cprosody rate\u003d\"1.08\"\u003eIn a quarter mile, Take the \u003cphoneme alphabet\u003d\u0027nt-sampa\u0027 ph\u003d\u0027au|to|\"Bi|a \"a \"u|no\u0027\u003eA-1\u003c/phoneme\u003e ramp.\u003c/prosody\u003e\u003c/amazon:effect\u003e\u003c/speak\u003e"},{"distanceAlongGeometry":200.0,"announcement":"Take the A-1 ramp toward M-40, M-30.","ssmlAnnouncement":"\u003cspeak\u003e\u003camazon:effect name\u003d\"drc\"\u003e\u003cprosody rate\u003d\"1.08\"\u003eTake the \u003cphoneme alphabet\u003d\u0027nt-sampa\u0027 ph\u003d\u0027au|to|\"Bi|a \"a \"u|no\u0027\u003eA-1\u003c/phoneme\u003e ramp toward \u003cphoneme alphabet\u003d\u0027nt-sampa\u0027 ph\u003d\u0027\"e|me kwa|\"ren|ta\u0027\u003eM-40\u003c/phoneme\u003e, \u003cphoneme alphabet\u003d\u0027nt-sampa\u0027 ph\u003d\u0027\"e|me \"trein|ta\u0027\u003eM-30\u003c/phoneme\u003e.\u003c/prosody\u003e\u003c/amazon:effect\u003e\u003c/speak\u003e"}],"bannerInstructions":[{"distanceAlongGeometry":475.806,"primary":{"text":"A-1","components":[{"text":"A-1","type":"icon"}],"type":"turn","modifier":"slight right"},"secondary":{"text":"M-40 / M-30","components":[{"text":"M-40","type":"icon","mapbox_shield":{"base_url":"https://api.mapbox.com/styles/v1","name":"default","text_color":"black","display_ref":"M-40"}},{"text":"/","type":"delimiter"},{"text":"M-30","type":"icon","mapbox_shield":{"base_url":"https://api.mapbox.com/styles/v1","name":"default","text_color":"black","display_ref":"M-30"}}],"type":"turn","modifier":"slight right"}}],"driving_side":"right","weight":38.252,"intersections":[{"duration":3.886,"turn_weight":5.5,"turn_duration":0.009,"weight":9.474,"location":[-3.58417,40.58237],"bearings":[139,181,357],"entry":[true,true,false],"in":2,"out":1,"geometry_index":81,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"secondary"}},{"duration":2.838,"turn_weight":0.5,"weight":2.913,"location":[-3.58423,40.58187],"bearings":[9,190],"entry":[false,true],"in":0,"out":1,"geometry_index":86,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"secondary"}},{"duration":1.938,"turn_weight":0.5,"weight":2.148,"location":[-3.5843,40.58151],"bearings":[7,185],"entry":[false,true],"in":0,"out":1,"geometry_index":89,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"secondary"}},{"duration":3.115,"turn_weight":0.5,"weight":3.148,"location":[-3.58433,40.58126],"bearings":[5,185],"entry":[false,true],"in":0,"out":1,"geometry_index":90,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"secondary"}},{"duration":7.338,"turn_weight":0.5,"weight":6.738,"location":[-3.58438,40.58086],"bearings":[5,185],"entry":[false,true],"in":0,"out":1,"geometry_index":91,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"secondary"}},{"duration":7.962,"turn_weight":0.5,"weight":7.267,"location":[-3.58449,40.57991],"bearings":[5,187],"entry":[false,true],"in":0,"out":1,"geometry_index":92,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"secondary"}},{"duration":1.358,"turn_weight":0.5,"weight":1.655,"location":[-3.58499,40.57898],"bearings":[42,231],"entry":[false,true],"in":0,"out":1,"geometry_index":101,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"secondary"}},{"duration":3.057,"turn_weight":0.5,"weight":3.098,"location":[-3.58517,40.57887],"bearings":[51,241],"entry":[false,true],"in":0,"out":1,"geometry_index":103,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"secondary"}},{"turn_weight":0.5,"location":[-3.58565,40.57871],"bearings":[71,261],"entry":[false,true],"in":0,"out":1,"geometry_index":108,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"secondary"}}]},{"weight_typical":85.501,"distance":1423.96,"duration":71.784,"duration_typical":73.575,"speedLimitUnit":"km/h","speedLimitSign":"vienna","geometry":"ofvklAvuzyEoAbL{@nF{@rD{@jCoAjCcBvBcBnAcBz@cBf@oARwBRcB?wBSwBg@cB{@oA{@oAoA{@oA{@cB{@kCg@kCg@sDS_D?_DR_DRcBz@_Dz@wBz@cBbBwBvBcBvBoAjC{@vBg@vBSvB?rDRvBRrDf@rDf@nFz@~CRjC?fFKzDGnKnArNvB~RjCvQvBjW~CzTjCnU~CbV~C~RjC~MvBfOvB~MvBfJnAvLvBnUfEjRrD~MjCbLjCbQfEzTbGfTbGfTbG~RbGvLrDrIjCnKrDvLfEfObGfTrIzYvLrSfJb[zO","name":"Autovía del Norte","ref":"A-1; E-5","destinations":"A-1, M-40, M-30, M-50, R-2: Madrid, Zona Industrial, S. Sebastián de los Reyes","mode":"driving","pronunciation":"au|to|\"Bi|a %del \"nor|te","maneuver":{"location":[-3.5859,40.57868],"bearing_before":261.0,"bearing_after":284.0,"instruction":"Take the A-1 ramp toward M-40/M-30/M-50/R-2.","type":"on ramp","modifier":"slight right"},"voiceInstructions":[{"distanceAlongGeometry":1413.96,"announcement":"In 1 mile, Keep left to stay on A-1.","ssmlAnnouncement":"\u003cspeak\u003e\u003camazon:effect name\u003d\"drc\"\u003e\u003cprosody rate\u003d\"1.08\"\u003eIn 1 mile, Keep left to stay on \u003cphoneme alphabet\u003d\u0027nt-sampa\u0027 ph\u003d\u0027au|to|\"Bi|a \"a \"u|no\u0027\u003eA-1\u003c/phoneme\u003e.\u003c/prosody\u003e\u003c/amazon:effect\u003e\u003c/speak\u003e"},{"distanceAlongGeometry":804.672,"announcement":"In a half mile, Keep left to stay on A-1.","ssmlAnnouncement":"\u003cspeak\u003e\u003camazon:effect name\u003d\"drc\"\u003e\u003cprosody rate\u003d\"1.08\"\u003eIn a half mile, Keep left to stay on \u003cphoneme alphabet\u003d\u0027nt-sampa\u0027 ph\u003d\u0027au|to|\"Bi|a \"a \"u|no\u0027\u003eA-1\u003c/phoneme\u003e.\u003c/prosody\u003e\u003c/amazon:effect\u003e\u003c/speak\u003e"},{"distanceAlongGeometry":320.0,"announcement":"Keep left to stay on A-1, E-5 toward M-40, M-30.","ssmlAnnouncement":"\u003cspeak\u003e\u003camazon:effect name\u003d\"drc\"\u003e\u003cprosody rate\u003d\"1.08\"\u003eKeep left to stay on \u003cphoneme alphabet\u003d\u0027nt-sampa\u0027 ph\u003d\u0027au|to|\"Bi|a \"a \"u|no\u0027\u003eA-1\u003c/phoneme\u003e, \u003cphoneme alphabet\u003d\u0027nt-sampa\u0027 ph\u003d\u0027\"e \"TiN|ko\u0027\u003eE-5\u003c/phoneme\u003e toward \u003cphoneme alphabet\u003d\u0027nt-sampa\u0027 ph\u003d\u0027\"e|me kwa|\"ren|ta\u0027\u003eM-40\u003c/phoneme\u003e, \u003cphoneme alphabet\u003d\u0027nt-sampa\u0027 ph\u003d\u0027\"e|me \"trein|ta\u0027\u003eM-30\u003c/phoneme\u003e.\u003c/prosody\u003e\u003c/amazon:effect\u003e\u003c/speak\u003e"}],"bannerInstructions":[{"distanceAlongGeometry":1423.96,"primary":{"text":"A-1","components":[{"text":"A-1","type":"icon"}],"type":"fork","modifier":"left"},"secondary":{"text":"M-40 / M-30","components":[{"text":"M-40","type":"icon","mapbox_shield":{"base_url":"https://api.mapbox.com/styles/v1","name":"default","text_color":"black","display_ref":"M-40"}},{"text":"/","type":"delimiter"},{"text":"M-30","type":"icon","mapbox_shield":{"base_url":"https://api.mapbox.com/styles/v1","name":"default","text_color":"black","display_ref":"M-30"}}],"type":"fork","modifier":"left"},"view":{"text":"","components":[{"text":"","type":"guidance-view","subType":"jct","imageURL":"https://api.mapbox.com/guidance-views/v1/1662595200/jct/JV_8115959870?arrow_ids\u003dJV_8115959871"},{"text":"","type":"guidance-view","subType":"signboard","imageURL":"https://api.mapbox.com/guidance-views/v1/1662595200/signboard/SR_ES_811595987A1"}],"type":"fork","modifier":"left"}}],"driving_side":"right","weight":83.978,"intersections":[{"duration":2.19,"turn_weight":2.25,"turn_duration":0.03,"weight":4.086,"location":[-3.5859,40.57868],"bearings":[81,270,284],"entry":[false,true,true],"in":0,"out":2,"geometry_index":111,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"secondary_link"}},{"duration":29.16,"weight":24.786,"location":[-3.58611,40.57872],"bearings":[104,291],"entry":[false,true],"in":0,"out":1,"geometry_index":112,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"secondary_link"}},{"duration":3.24,"weight":2.754,"location":[-3.5855,40.57897],"bearings":[1,189],"entry":[false,true],"in":0,"out":1,"geometry_index":148,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"secondary_link"}},{"duration":2.76,"weight":2.346,"location":[-3.58555,40.57873],"bearings":[10,189],"entry":[false,true],"in":0,"out":1,"geometry_index":151,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"secondary_link"}},{"duration":3.72,"weight":3.162,"location":[-3.58559,40.57853],"bearings":[8,179],"entry":[false,true],"in":0,"out":1,"geometry_index":153,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"secondary_link"}},{"weight":21.979,"turn_weight":20.75,"duration":1.46,"turn_duration":0.014,"location":[-3.58558,40.57825],"bearings":[10,189,358],"classes":["motorway"],"entry":[false,true,false],"in":2,"out":1,"geometry_index":156,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":6.69,"weight":5.686,"location":[-3.58568,40.5778],"bearings":[10,189],"classes":["motorway"],"entry":[false,true],"in":0,"out":1,"lanes":[{"valid":true,"active":true,"valid_indication":"straight","indications":["straight"]},{"valid":true,"active":true,"valid_indication":"straight","indications":["straight"]},{"valid":true,"active":true,"valid_indication":"straight","indications":["straight"]},{"valid":true,"active":true,"valid_indication":"straight","indications":["straight"]}],"geometry_index":158,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":1.786,"weight":1.518,"location":[-3.58612,40.57571],"bearings":[9,189],"classes":["motorway"],"entry":[false,true],"in":0,"out":1,"lanes":[{"valid":true,"active":true,"valid_indication":"straight","indications":["straight"]},{"valid":true,"active":true,"valid_indication":"straight","indications":["straight"]},{"valid":true,"active":true,"valid_indication":"straight","indications":["straight"]},{"valid":true,"active":true,"valid_indication":"straight","indications":["straight"]}],"geometry_index":164,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":1.616,"weight":1.373,"location":[-3.58625,40.57515],"bearings":[11,190],"classes":["motorway"],"entry":[false,true],"in":0,"out":1,"geometry_index":166,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":4.904,"weight":4.168,"location":[-3.58637,40.57465],"bearings":[11,190],"classes":["motorway"],"entry":[false,true],"in":0,"out":1,"geometry_index":168,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":5.386,"weight":4.578,"location":[-3.5868,40.57313],"bearings":[14,195],"classes":["motorway"],"entry":[false,true],"in":0,"out":1,"geometry_index":174,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":6.18,"weight":5.253,"location":[-3.58742,40.57149],"bearings":[17,197],"classes":["motorway"],"entry":[false,true],"in":0,"out":1,"geometry_index":179,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"location":[-3.58829,40.56965],"bearings":[21,203],"classes":["motorway"],"entry":[false,true],"in":0,"out":1,"lanes":[{"valid":true,"active":true,"valid_indication":"straight","indications":["straight"]},{"valid":true,"active":true,"valid_indication":"straight","indications":["straight"]},{"valid":true,"active":true,"valid_indication":"straight","indications":["straight","slight right"]},{"valid":true,"active":true,"valid_indication":"straight","indications":["straight"]}],"geometry_index":186,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}}]},{"guidance_views":[{"overlay_ids":["JV_8115959871"],"base_id":"JV_8115959870","type":"jct","data_id":"1662595200"},{"overlay_ids":[],"base_id":"SR_ES_811595987A1","type":"signboard","data_id":"1662595200"}],"weight_typical":66.186,"distance":2554.238,"duration":74.33,"duration_typical":76.712,"speedLimitUnit":"km/h","speedLimitSign":"vienna","geometry":"kacklAfg`zEz^jRvV~M~a@vVzc@fYb[rSzObLzOvLjRfOnKrIfTjRrS~RzTbVvG~HvGrIjMbQvQrXbLvQrIrNnFrIjHvLr]jk@nKnPfh@jz@~iAnjBbe@ju@reAzdBvGnKzJnPbe@~u@jWja@nFrIjHvLbe@ju@j\\zh@bVr]zJ~MrIbLnFvGjMrNvLvLjMjMbGnFzO~MbLrIjMrIjM~HjHfEvGrD~MvGbQ~HjRjHvLfEbLrD~MpD","name":"Autovía del Norte","ref":"A-1; E-5","destinations":"A-1, M-40, M-30: Madrid, Aeropuerto","mode":"driving","pronunciation":"au|to|\"Bi|a %del \"nor|te","maneuver":{"location":[-3.58874,40.56887],"bearing_before":205.0,"bearing_after":205.0,"instruction":"Keep left to stay on A-1/E-5/Autovía del Norte toward M-40/M-30/Madrid/Aeropuerto.","type":"fork","modifier":"slight left"},"voiceInstructions":[{"distanceAlongGeometry":2514.238,"announcement":"In 1.5 miles, Your destination will be on the right.","ssmlAnnouncement":"\u003cspeak\u003e\u003camazon:effect name\u003d\"drc\"\u003e\u003cprosody rate\u003d\"1.08\"\u003eIn 1.5 miles, Your destination will be on the right.\u003c/prosody\u003e\u003c/amazon:effect\u003e\u003c/speak\u003e"},{"distanceAlongGeometry":804.672,"announcement":"In a half mile, Your destination will be on the right.","ssmlAnnouncement":"\u003cspeak\u003e\u003camazon:effect name\u003d\"drc\"\u003e\u003cprosody rate\u003d\"1.08\"\u003eIn a half mile, Your destination will be on the right.\u003c/prosody\u003e\u003c/amazon:effect\u003e\u003c/speak\u003e"},{"distanceAlongGeometry":166.667,"announcement":"Your destination is on the right.","ssmlAnnouncement":"\u003cspeak\u003e\u003camazon:effect name\u003d\"drc\"\u003e\u003cprosody rate\u003d\"1.08\"\u003eYour destination is on the right.\u003c/prosody\u003e\u003c/amazon:effect\u003e\u003c/speak\u003e"}],"bannerInstructions":[{"distanceAlongGeometry":2554.238,"primary":{"text":"Your destination will be on the right","components":[{"text":"Your destination will be on the right","type":"text"}],"type":"arrive","modifier":"right"}},{"distanceAlongGeometry":166.667,"primary":{"text":"Your destination is on the right","components":[{"text":"Your destination is on the right","type":"text"}],"type":"arrive","modifier":"right"}}],"driving_side":"right","weight":64.161,"intersections":[{"duration":8.852,"turn_duration":0.007,"weight":7.517,"location":[-3.58874,40.56887],"bearings":[25,205,218],"classes":["motorway"],"entry":[false,true,true],"in":0,"out":1,"geometry_index":188,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":12.444,"weight":10.577,"location":[-3.59042,40.56638],"bearings":[29,211],"classes":["motorway"],"entry":[false,true],"in":0,"out":1,"lanes":[{"valid":true,"active":false,"valid_indication":"straight","indications":["straight"]},{"valid":true,"active":false,"valid_indication":"straight","indications":["straight"]},{"valid":true,"active":true,"valid_indication":"straight","indications":["straight"]}],"geometry_index":193,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":0.794,"weight":0.675,"location":[-3.59361,40.56329],"bearings":[47,228],"classes":["motorway"],"entry":[false,true],"in":0,"out":1,"geometry_index":205,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":0.567,"weight":0.482,"location":[-3.59386,40.56312],"bearings":[48,227],"classes":["motorway"],"entry":[false,true],"in":0,"out":1,"geometry_index":206,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":3.94,"weight":3.349,"location":[-3.59403,40.563],"bearings":[47,228],"classes":["motorway"],"entry":[false,true],"in":0,"out":1,"geometry_index":207,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":11.509,"weight":9.782,"location":[-3.59524,40.56216],"bearings":[47,228],"classes":["motorway"],"entry":[false,true],"in":0,"out":1,"geometry_index":210,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":5.953,"weight":5.06,"location":[-3.59878,40.55969],"bearings":[47,228],"classes":["motorway"],"entry":[false,true],"in":0,"out":1,"geometry_index":213,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"weight":1.771,"turn_weight":1,"duration":0.915,"turn_duration":0.008,"location":[-3.60061,40.55842],"bearings":[28,47,228],"classes":["motorway"],"entry":[false,false,true],"in":1,"out":2,"geometry_index":215,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":2.863,"weight":2.434,"location":[-3.60089,40.55823],"bearings":[48,228],"classes":["motorway"],"entry":[false,true],"in":0,"out":1,"geometry_index":216,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":1.814,"weight":1.542,"location":[-3.60177,40.55762],"bearings":[48,227],"classes":["motorway"],"entry":[false,true],"in":0,"out":1,"geometry_index":217,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":0.567,"weight":0.482,"location":[-3.60232,40.55723],"bearings":[47,227],"classes":["motorway"],"entry":[false,true],"in":0,"out":1,"geometry_index":218,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":0.763,"weight":0.648,"location":[-3.60249,40.55711],"bearings":[47,228],"classes":["motorway"],"entry":[false,true],"in":0,"out":1,"geometry_index":219,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":16.627,"weight":14.133,"location":[-3.60271,40.55696],"bearings":[48,227],"classes":["motorway"],"entry":[false,true],"in":0,"out":1,"geometry_index":220,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":0.58,"weight":0.493,"location":[-3.60689,40.55328],"bearings":[28,207],"classes":["motorway"],"entry":[false,true],"in":0,"out":1,"geometry_index":234,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":0.519,"weight":0.441,"location":[-3.60699,40.55313],"bearings":[27,206],"classes":["motorway"],"entry":[false,true],"in":0,"out":1,"geometry_index":235,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"duration":3.875,"weight":3.293,"location":[-3.60708,40.55299],"bearings":[26,204],"classes":["motorway"],"entry":[false,true],"in":0,"out":1,"geometry_index":236,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}},{"turn_duration":0.007,"location":[-3.60763,40.55193],"bearings":[1,19,198],"classes":["motorway"],"entry":[false,false,true],"in":1,"out":2,"geometry_index":240,"is_urban":false,"admin_index":0,"mapbox_streets_v8":{"class":"motorway"}}]},{"weight_typical":0,"distance":0.0,"duration":0.0,"duration_typical":0.0,"speedLimitUnit":"km/h","speedLimitSign":"vienna","geometry":"obajlA`oe{E??","name":"Autovía del Norte","ref":"A-1; E-5","mode":"driving","pronunciation":"au|to|\"Bi|a %del \"nor|te","maneuver":{"location":[-3.607809,40.55148],"bearing_before":196.0,"bearing_after":0.0,"instruction":"Your destination is on the right.","type":"arrive","modifier":"right"},"voiceInstructions":[],"bannerInstructions":[],"driving_side":"right","weight":0.0,"intersections":[{"location":[-3.607809,40.55148],"bearings":[16],"entry":[true],"in":0,"geometry_index":242,"admin_index":0}]}],"annotation":{"distance":[33.7,86.6,62.0,9.2,18.3,35.4,19.2,36.2,21.6,22.7,13.6,30.5,16.8,36.2,24.7,52.9,33.3,19.4,23.7,21.5,19.2,19.2,20.5,10.6,3.4,11.9,12.6,11.7,13.4,16.8,21.5,20.0,17.7,15.7,15.0,17.1,19.1,19.0,15.6,12.3,1.1,51.5,80.5,24.6,16.8,19.1,12.4,14.7,11.9,9.3,8.1,8.1,7.9,0.9,6.0,7.6,5.4,6.1,4.2,5.1,2.5,3.3,6.8,5.5,5.7,8.2,6.5,8.1,6.1,7.5,6.0,8.5,9.5,6.8,8.2,7.0,7.1,6.9,5.6,6.6,6.8,17.8,10.0,7.9,10.1,10.2,9.1,15.7,15.7,28.0,44.7,106.2,15.6,16.9,12.5,14.0,10.9,8.9,12.1,11.7,12.3,10.1,9.4,8.8,9.6,10.3,7.1,8.8,12.0,6.9,2.5,18.3,10.7,8.3,6.8,7.4,7.5,6.5,6.1,5.9,4.5,6.7,5.6,6.7,6.9,6.1,5.1,5.6,4.8,5.4,6.8,6.3,7.9,6.9,6.7,6.9,4.4,7.5,6.1,5.4,7.5,7.9,7.5,8.2,6.9,6.7,6.7,10.0,6.8,10.1,10.2,13.6,8.9,7.8,12.9,10.5,22.5,28.3,36.1,33.8,44.0,39.4,40.6,41.8,36.1,27.2,29.3,27.2,20.4,25.0,40.9,35.4,27.3,24.1,33.4,40.5,39.4,39.4,37.3,25.7,19.8,23.5,25.9,31.0,40.5,51.3,39.8,55.0,62.6,46.9,70.1,74.7,57.3,34.9,35.4,40.9,26.5,46.1,45.6,49.9,20.7,21.2,35.4,48.2,34.5,28.4,19.6,25.0,81.1,32.5,108.9,197.5,100.1,186.6,23.0,31.8,100.7,63.6,19.7,25.0,100.1,77.1,58.5,29.3,25.9,17.9,33.2,30.7,32.2,17.7,36.2,27.5,29.3,29.0,18.7,17.4,29.2,35.0,36.8,25.9,24.6,27.7],"duration":[1.039,2.677,1.908,0.284,0.561,1.084,0.59,1.112,0.66,0.694,0.419,0.94,0.521,1.113,0.762,1.63,1.684,0.97,1.189,1.072,0.905,0.905,0.964,0.498,0.157,0.544,0.591,0.545,0.632,0.786,1.007,0.937,0.831,0.733,0.706,0.798,0.895,0.89,0.747,0.592,0.052,2.883,4.604,1.408,0.96,1.803,1.167,1.387,1.142,0.876,0.766,0.763,0.748,0.083,0.616,0.756,0.54,0.829,0.414,0.506,0.246,0.328,0.716,0.592,0.598,1.05,0.682,0.851,0.636,0.79,0.631,1.061,0.907,0.644,0.77,0.663,0.677,0.653,0.699,0.669,0.674,1.242,0.696,0.542,0.703,0.703,0.635,1.106,1.098,1.938,3.115,7.338,1.086,1.17,0.866,0.971,0.753,0.614,0.838,0.812,0.851,0.703,0.655,0.605,0.656,0.708,0.489,0.6,0.868,0.497,0.178,2.19,1.282,0.997,0.816,0.889,0.904,0.782,0.734,0.698,0.544,0.808,0.668,0.808,0.827,0.734,0.615,0.671,0.57,0.647,0.816,0.759,0.952,0.823,0.812,0.823,0.525,0.905,0.729,0.647,0.904,0.949,0.899,0.984,0.827,0.808,0.802,1.207,0.806,1.217,1.217,1.665,1.095,0.93,1.536,1.255,0.655,0.805,1.025,0.959,1.248,1.119,1.154,1.185,1.019,0.767,0.839,0.777,0.576,0.709,1.16,1.001,0.775,0.683,0.946,1.148,1.117,1.117,1.057,0.728,0.563,0.668,0.735,0.879,1.149,1.458,1.129,1.564,1.782,1.332,1.991,2.119,1.628,0.989,1.001,1.159,0.751,1.304,1.293,1.416,0.585,0.601,1.004,1.364,0.977,0.794,0.567,0.711,2.306,0.924,3.082,5.592,2.835,5.3,0.653,0.915,2.863,1.814,0.567,0.763,3.057,2.355,1.784,0.895,0.792,0.545,1.014,0.939,0.982,0.54,1.107,0.838,0.896,0.884,0.58,0.519,0.892,1.069,1.123,0.791,0.827,0.924],"speed":[32.4,32.3,32.5,32.6,32.6,32.6,32.6,32.6,32.7,32.7,32.4,32.4,32.4,32.4,32.4,32.4,20.0,20.0,20.0,20.0,21.2,21.2,21.2,21.2,21.9,21.9,21.3,21.3,21.3,21.3,21.3,21.3,21.3,21.3,21.3,21.3,21.3,21.3,20.9,20.9,20.9,17.9,17.5,17.5,17.5,10.6,10.6,10.6,10.6,10.6,10.6,10.6,10.6,10.6,10.0,10.0,10.0,10.1,10.1,10.1,10.1,10.1,9.4,9.4,9.4,9.6,9.6,9.6,9.6,9.6,9.6,10.5,10.5,10.5,10.5,10.5,10.5,10.5,10.0,10.0,10.0,14.5,14.5,14.5,14.5,14.5,14.3,14.3,14.3,14.4,14.4,14.5,14.4,14.4,14.4,14.4,14.4,14.4,14.4,14.4,14.4,14.4,14.4,14.6,14.6,14.6,14.6,14.6,13.9,13.9,13.9,8.5,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.3,8.2,8.2,8.4,8.4,8.4,35.1,35.1,35.2,35.2,35.2,35.2,35.2,35.2,35.4,35.4,35.0,35.0,35.3,35.3,35.3,35.3,35.3,35.3,35.3,35.3,35.3,35.3,35.3,35.2,35.2,35.2,35.2,35.2,35.2,35.2,35.2,35.2,35.2,35.2,35.2,35.2,35.2,35.3,35.3,35.3,35.3,35.3,35.3,35.3,35.3,35.3,35.3,35.3,35.3,35.7,34.6,35.2,35.2,35.2,35.3,35.3,35.3,35.2,35.2,35.0,35.2,35.1,34.6,32.8,32.8,32.8,32.8,32.8,32.8,32.8,32.8,32.8,32.8,32.8,32.8,32.8,32.8,32.8,32.3,33.4,32.8,32.8,32.8,32.8,30.0,30.0],"maxspeed":[{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true},{"unknown":true}],"congestion_numeric":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,6,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,4,4,4,4,4,4,4,3,3,3,3,3,3,3,null,4,4,4,4,4,4,4,4,4,0,0,0,0,0,0,0,3,3,3,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,null,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}}],"routeOptions":{"baseUrl":"https://api.mapbox.com","user":"mapbox","profile":"driving-traffic","coordinates":"-3.587,40.5719;-3.607835,40.551486","language":"en","continue_straight":true,"roundabout_exits":true,"geometries":"polyline6","overview":"full","steps":true,"annotations":"congestion_numeric,maxspeed,closure,speed,duration,distance","voice_instructions":true,"banner_instructions":true,"voice_units":"imperial","enable_refresh":true},"voiceLocale":"en-US","requestUuid":"6CU8OYo0iEtDImOtN9u3WoLhzJGK8n4o-X4l0hIonvd0jEtyqt6S-Q\u003d\u003d"}""")
        .toNavigationRoute(RouterOrigin.Offboard)
    private lateinit var binding: MapboxActivitySignboardBinding

    private val mapboxReplayer = MapboxReplayer()
    private val navigationLocationProvider = NavigationLocationProvider()

    /**
     * The [MapboxSignboardApi] consumes banner instructions data and produces signboard related
     * data that is consumed by the [MapboxSignboardView] in the view layout.
     *
     * * Uses a specific access token required for the route request to send signboards in the response.
     */
    private val signboardApi: MapboxSignboardApi by lazy {
        MapboxSignboardApi(getString(R.string.mapbox_access_token), applicationContext)
    }

    /**
     * The result of invoking [MapboxSignboardApi.generateSignboard] is returned as a callback
     * containing either a success in the form of [SignboardValue] or failure in the form of
     * [SignboardError].
     */
    private val signboardCallback =
        MapboxNavigationConsumer<Expected<SignboardError, SignboardValue>> { expected ->
            // The data obtained must be rendered by [MapboxSignboardView]
            binding.signboardView.isVisible = expected.isValue
            binding.signboardView.render(expected)
        }

    private val routeLineResources: RouteLineResources by lazy {
        RouteLineResources.Builder().build()
    }

    private val options: MapboxRouteLineOptions by lazy {
        MapboxRouteLineOptions.Builder(this)
            .withRouteLineResources(routeLineResources)
            .withRouteLineBelowLayerId("road-label-navigation")
            .build()
    }

    private val routeLineView by lazy {
        MapboxRouteLineView(options)
    }

    private val routeLineApi: MapboxRouteLineApi by lazy {
        MapboxRouteLineApi(options)
    }

    private val replayProgressObserver = ReplayProgressObserver(mapboxReplayer)

    private val locationObserver = object : LocationObserver {
        override fun onNewRawLocation(rawLocation: Location) {}
        override fun onNewLocationMatcherResult(locationMatcherResult: LocationMatcherResult) {
            navigationLocationProvider.changePosition(
                locationMatcherResult.enhancedLocation,
                locationMatcherResult.keyPoints,
            )
            updateCamera(locationMatcherResult.enhancedLocation)
        }
    }

    private val routesObserver = RoutesObserver { result ->
        if (result.navigationRoutes.isNotEmpty()) {
            lifecycleScope.launch {
                routeLineApi.setNavigationRoutes(listOf(result.navigationRoutes[0])).apply {
                    routeLineView.renderRouteDrawData(
                        binding.mapView.getMapboxMap().getStyle()!!,
                        this
                    )
                }
            }
        }
    }

    private val bannerInstructionsObserver = BannerInstructionsObserver { bannerInstructions ->
        // The signboard component is driven by banner instructions updates.
        // Passing the instructions to the MapboxSignboardApi generates the data
        // for updating the view.
        signboardApi.generateSignboard(bannerInstructions, signboardCallback)
    }

    private val mapboxNavigation: MapboxNavigation by requireMapboxNavigation(
        onResumedObserver = object : MapboxNavigationObserver {
            @SuppressLint("MissingPermission")
            override fun onAttached(mapboxNavigation: MapboxNavigation) {
                mapboxNavigation.registerRoutesObserver(routesObserver)
                mapboxNavigation.registerLocationObserver(locationObserver)
                mapboxNavigation.registerRouteProgressObserver(replayProgressObserver)
                mapboxNavigation.registerBannerInstructionsObserver(bannerInstructionsObserver)
                mapboxNavigation.startTripSession()
            }

            override fun onDetached(mapboxNavigation: MapboxNavigation) {
                mapboxNavigation.unregisterRoutesObserver(routesObserver)
                mapboxNavigation.unregisterLocationObserver(locationObserver)
                mapboxNavigation.unregisterRouteProgressObserver(replayProgressObserver)
                mapboxNavigation.unregisterBannerInstructionsObserver(bannerInstructionsObserver)
            }
        },
        onInitialize = this::initNavigation
    )

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // Look at LayoutActivitySignboardBinding to see the view component in the
        // activity's layout.
        binding = MapboxActivitySignboardBinding.inflate(layoutInflater)
        setContentView(binding.root)

        binding.mapView.getMapboxMap().loadStyleUri(NavigationStyles.NAVIGATION_DAY_STYLE) {
            binding.actionButton.setOnClickListener {
                mapboxNavigation.setNavigationRoutes(listOf(route))
                binding.actionButton.visibility = View.GONE
            }
        }
    }

    override fun onDestroy() {
        super.onDestroy()
        routeLineApi.cancel()
        routeLineView.cancel()
        signboardApi.cancelAll()
        mapboxReplayer.finish()
    }

    private fun initNavigation() {
        MapboxNavigationApp.setup(
            NavigationOptions.Builder(this)
                .accessToken(getString(R.string.mapbox_access_token))
                // comment out the location engine setting block to disable simulation
                .locationEngine(ReplayLocationEngine(mapboxReplayer))
                .build()
        )

        binding.mapView.location.apply {
            setLocationProvider(navigationLocationProvider)
            enabled = true
        }

        replayOriginLocation()
    }

    private fun replayOriginLocation() {
        mapboxReplayer.pushEvents(
            listOf(
                ReplayRouteMapper.mapToUpdateLocation(
                    Date().time.toDouble(),
                    Point.fromLngLat(-3.587, 40.5719)
                )
            )
        )
        mapboxReplayer.playFirstLocation()
        mapboxReplayer.playbackSpeed(3.0)
    }

    private fun updateCamera(location: Location) {
        val mapAnimationOptionsBuilder = MapAnimationOptions.Builder()
        mapAnimationOptionsBuilder.duration(1500L)
        binding.mapView.camera.easeTo(
            CameraOptions.Builder()
                .center(Point.fromLngLat(location.longitude, location.latitude))
                .bearing(location.bearing.toDouble())
                .pitch(45.0)
                .zoom(17.0)
                .padding(EdgeInsets(1000.0, 0.0, 0.0, 0.0))
                .build(),
            mapAnimationOptionsBuilder.build()
        )
    }
}
